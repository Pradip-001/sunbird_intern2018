"use strict";angular.module("playerApp").controller("SearchResultController",["$scope","$rootScope","config","$timeout","$state","$stateParams","searchService","toasterService","$location","sessionService","adminService","permissionsService","PaginationService","telemetryService",function(e,s,r,a,c,t,o,h,n,i,l,d,g,u){function y(e,s,r,a){var c={};return c.showError=!0,c.isClose=e,c.message=s,c.messageType=r,a&&(c.messageText=a),c}e.search={},s.search={},s.search.searchKeyword="",s.search.filters={},s.search.typingTimer=-1,s.search.doneTypingInterval=1e3,s.search.languages=r.FILTER.RESOURCES.languages,s.search.contentTypes=r.FILTER.RESOURCES.contentTypes,s.search.subjects=r.FILTER.RESOURCES.subjects,s.search.grades=r.DROPDOWN.COMMON.grades,s.search.boards=r.FILTER.RESOURCES.boards,e.search.searchTypeKeys=r.searchTypeKeys,s.search.sortingOptions=r.sortingOptions,s.search.sortBy={createdOn:"asc"},e.search.searchSelectionKeys=r.searchSelectionKeys,s.search.sortIcon=!0,s.search.selectedLanguage=[],s.search.selectedContentType=[],s.search.selectedSubject=[],s.search.selectedBoard=[],s.search.selectedConcepts=[],s.search.selectedLocation="",s.search.selectedRoles=[],s.search.sortByOption={},e.search.autoSuggest=!0,s.search.selectedOrgType=[],s.search.pageLimit=20,s.search.pager={},s.userDownloadButtonVisibility=r.USER_SEARCH.DOWNLOAD_BUTTON_VISIBILITY,s.$watch("searchKey",function(){a(function(){s.search.selectedSearchKey=s.searchKey,s.$emit("DynSearchKey",{key:s.searchKey}),e.search.isSearchTypeKey=e.search.searchTypeKeys.includes(s.search.selectedSearchKey),$("#headerSearch").dropdown("set selected",!0===e.search.isSearchTypeKey?s.search.selectedSearchKey:"All"),s.search.searchKeyword=""},0)});var f=s.$on("initSearch",function(s,r){e.search.initSearch()}),p=s.$on("setSearchKey",function(r,a){s.search.selectedSearchKey=a.key,e.search.searchRequest(!1)});s.search.selectFilter=function(e,r,c){a(function(){var a=s.search[e].indexOf(r);-1===a?(s.search[e].push(r),$(c.target).addClass("active")):(s.search[e].splice(a,1),$(c.target).removeClass("active"))},0)},s.search.removeFilterSelection=function(e,r){if("selectedConcepts"===e)s.search[e]=_.filter(s.search[e],function(e){return e.identifier!==r}),s.search.broadCastConcepts();else{var a=s.search[e].indexOf(r);-1!==a&&s.search[e].splice(a,1)}},s.getRoleName=function(e){return _.find(s.search.userRoles,{role:e}).roleName},s.getOrgName=function(e){return _.find(s.search.orgTypes,{id:e}).name},s.expandFilters=function(){$("#filterIcon").parents(".active").length<=0&&$("#filterIcon").trigger("click")},e.search.initSearch=function(){var r=t;s.search.selectedSearchKey=s.searchKey||r.type,s.search.searchKeyword=s.search.searchKeyword||r.query,s.search.filters=JSON.parse(atob(r.filters||btoa("{}"))),s.search.sortBy=JSON.parse(atob(r.sort||btoa("{}"))),s.search.selectedLanguage=s.search.filters.language||[],s.search.selectedContentType=s.search.filters.contentType||[],s.search.selectedBoard=s.search.filters.board||[],s.search.selectedSubject=s.search.filters.subject||[],s.search.selectedGrades=s.search.filters.grade||[],s.search.selectedConcepts=s.search.filters.concepts||[],s.search.selectedLocation=s.search.filters.location||"",s.search.selectedRoles=s.search.filters["organisations.roles"]||[],s.search.broadCastConcepts(),s.search.sortByOption=Object.keys(s.search.sortBy).length>0?Object.keys(s.search.sortBy)[0]:"",s.search.searchFromSuggestion=t.autoSuggestSearch,s.search.selectedOrgType=s.search.filters.orgType||[],e.search.searchRequest()},s.search.openCourseView=function(e,r){var a="no";a=s.enrolledCourseIds[e.courseId||e.identifier]?"no":"yes";var t={courseType:r,courseId:e.courseId||e.identifier,lectureView:a,progress:e.progress,total:e.total,courseName:e.courseName||e.name,lastReadContentId:e.lastReadContentId};i.setSessionData("COURSE_PARAMS",t),c.go("Toc",t)},s.search.playContent=function(e){"application/vnd.ekstep.content-collection"===e.mimeType?c.go("PreviewCollection",{Id:e.identifier,name:e.name}):c.go("Player",{content:e,contentName:e.name,contentId:e.identifier})},s.search.setSearchText=function(r){s.search.searchKeyword=r,s.search.searchFromSuggestion=!0,e.search.searchRequest(!1)},e.search.autoSuggestSearch=function(){e.search.autoSuggest&&s.isSearchPage&&s.search.searchKeyword.length>2&&e.search.handleSearch()},e.search.keyUp=function(){clearTimeout(s.search.typingTimer),s.search.typingTimer=setTimeout(e.search.autoSuggestSearch,s.search.doneTypingInterval)},e.search.keyDown=function(){clearTimeout(s.search.typingTimer)},e.search.searchRequest=function(r){if(clearTimeout(s.search.typingTimer),!r||13===r.charCode)if(e.search.autoSuggest=!1,s.search.searchKeyword&&""!==s.search.searchKeyword||!s.isLearnPage&&!s.isResourcesPage||r){if(s.isSearchPage)if(s.isSearchResultsPage&&s.search.searchKeyword===t.query&&s.search.selectedSearchKey===t.type)s.search.error={},s.search.loader=h.loader("",s.messages.stmsg.m0005),e.search.handleSearch();else{e.search.autoSuggest=!1,s.search.filters.concepts=s.search.selectedConcepts;var a={type:s.search.selectedSearchKey,query:s.search.searchKeyword,filters:btoa(JSON.stringify(s.search.filters)),sort:btoa(JSON.stringify(s.search.sortBy)),autoSuggestSearch:s.search.searchFromSuggestion||!1};s.searchTelemetryId="search-"+s.search.selectedSearchKey.toLowerCase(),s.searchTelemetryPageid=s.search.selectedSearchKey.toLowerCase()+"-search",s.inviewLogs=[],c.go("Search",a,{reload:!0})}}else s.$broadcast("initPageSearch",{})},e.search.handleSearch=function(r){r=r||1;var a={query:s.search.searchKeyword,filters:s.search.filters,offset:(r-1)*s.search.pageLimit,limit:s.search.pageLimit};if("null"!==_.keys(s.search.sortBy)[0]&&(a.sort_by=s.search.sortBy),e.search.autoSuggest&&!1!==e.search.autoSuggest||(s.search.loader||(s.search.loader=h.loader("",s.messages.stmsg.m0005)),s.search.loader.showLoader=!0),a.filters.concepts&&a.filters.concepts.length>0&&(a.filters.concepts=_.map(s.search.selectedConcepts,"identifier")),"true"===s.search.searchFromSuggestion?(a.filters.name=a.query,a.query="",s.search.searchFromSuggestion="false"):delete a.filters.name,"Courses"===s.search.selectedSearchKey)e.search.searchFn=o.courseSearch(a),e.search.resultType="course";else if("Library"===s.search.selectedSearchKey){var c=JSON.parse(JSON.stringify(a));(!a.filters.contentType||_.isArray(a.filters.contentType)&&0===a.filters.contentType.length)&&(c.filters.contentType=["Collection","TextBook","LessonPlan","Resource","Story","Worksheet","Game"]),c.softConstraints={badgeAssertions:1},e.search.searchFn=o.contentSearch(c),e.search.resultType="content",a.filters.objectType=["Content"]}else if("All"===s.search.selectedSearchKey){var n=JSON.parse(JSON.stringify(a));n.filters.contentType=["Collection","TextBook","LessonPlan","Resource","Course"],e.search.searchFn=o.search(n),e.search.resultType="content",a.filters.objectType=["Content"]}else if("Users"===s.search.selectedSearchKey){var i=/\S+@\S+\.\S+/,u=i.test(a.query);!0===u&&(a.filters.email=a.query),!1===u&&a.filters.email&&delete a.filters.email,a.sort_by&&delete a.sort_by,s.search.filters.orgType&&(s.search.filters.orgType=void 0,s.search.selectedOrgType=void 0),a.filters.objectType=["user"],a.softConstraints={badgeAssertions:1},e.search.currentUserRoles=d.getCurrentUserRoles();var f=e.search.currentUserRoles.includes("SYSTEM_ADMINISTRATION");!1===f&&(a.filters.rootOrgId=s.rootOrgId),e.search.searchFn=l.userSearch({request:a}),e.search.resultType="users"}else"Organisations"===s.search.selectedSearchKey&&(a.sort_by&&delete a.sort_by,e.search.searchFn=l.orgSearch({request:a}),e.search.resultType="organisations");e.search.searchFn.then(function(a){if(null===a||"OK"!==a.responseCode)throw s.search.loader.showLoader=!1,s.search.error=y(!0,s.messages.fmsg.m0004,s.messages.emsg.m0002),e.search.autoSuggest=!0,clearTimeout(s.search.typingTimer),new Error("");s.search.autosuggest_data=[];var c={};c="Organisations"===s.search.selectedSearchKey||"Users"===s.search.selectedSearchKey?a.result.response:a.result,e.search.autoSuggest&&s.search.searchKeyword!==t.query?(s.search.autosuggest_data=c[e.search.resultType]||[],s.search.autosuggest_data.length>0&&$("#search-suggestions").addClass("visible").removeClass("hidden")):(s.search.searchResultKeyword=s.search.searchKeyword,$("#search-suggestions").addClass("hidden").removeClass("visible"),s.search.loader.showLoader=!1,0===c.count?s.search.error=y(!0,s.messages.stmsg.m0006,s.messages.stmsg.m0008,s.messages.stmsg.m0007):(s.search.error={},s.search.searchResult=c,s.search.pager=g.GetPager(c.count,r,s.search.pageLimit))),e.search.autoSuggest=!0,clearTimeout(s.search.typingTimer)}).catch(function(e){s.search.loader.showLoader=!1,s.search.error=y(!0,s.messages.fmsg.m0004,s.messages.emsg.m0002)})};var S=e.$on("selectedConcepts",function(r,a){s.search.selectedConcepts=a.selectedConcepts,_.defer(function(){e.$apply()})});s.search.broadCastConcepts=function(){s.$broadcast("selectedConceptsFromSearch",{selectedConcepts:s.search.selectedConcepts})},s.search.getUserRoles=function(){s.search.userRoles||(s.search.userRoles=d.getMainRoles(),s.search.userRoles=_.sortBy(s.search.userRoles,"roleName"))},s.search.applyFilter=function(){s.search.filters.language=s.search.selectedLanguage,s.search.filters.subject=s.search.selectedSubject,"Users"===s.search.selectedSearchKey?(s.search.filters.board=void 0,s.search.filters.concepts=void 0,s.search.filters.contentType=void 0,s.search.filters.orgType=void 0,s.search.filters.grade=s.search.selectedGrades,s.search.filters.location=""!==s.search.selectedLocation.trim()?s.search.selectedLocation.trim():void 0,s.search.filters["organisations.roles"]=s.search.selectedRoles):"Organisations"===s.search.selectedSearchKey?(s.search.filters={},s.search.filters.orgTypeId=s.search.selectedOrgType):(s.search.filters.board=s.search.selectedBoard,s.search.filters.concepts=s.search.selectedConcepts,s.search.filters.contentType=s.search.selectedContentType),s.isSearchResultsPage=!1,e.search.searchRequest()},s.search.resetFilter=function(){s.isSearchPage=!1,s.search.selectedLanguage=[],s.search.selectedContentType=[],s.search.selectedSubject=[],s.search.selectedBoard=[],s.search.selectedConcepts=[],s.search.selectedLocation="",s.search.selectedRoles=[],s.search.broadCastConcepts(),s.search.filters={},s.isSearchResultsPage=!1,s.isSearchPage=!0,s.search.selectedGrades=[],s.search.selectedOrgType=[],e.search.searchRequest()},s.search.applySorting=function(){var r=s.search.sortByOption;s.search.sortBy={},s.search.sortBy[r]=!0===s.search.sortIcon?"asc":"desc",e.search.searchRequest()},s.search.close=function(){"Users"!==s.search.selectedSearchKey&&"Organisations"!==s.search.selectedSearchKey||c.go("Profile"),"All"===s.search.selectedSearchKey?c.go("Home"):"Library"===s.search.selectedSearchKey?c.go("Resources"):c.go(s.search.selectedSearchKey)},s.search.setSearchKey=function(e){s.$emit("setSearchKey",{key:e}),s.$emit("DynsetSearchKey",{key:e})},e.$on("$destroy",function(){S(),f(),p()}),s.search.setPage=function(r){e.search.autoSuggest=!1,r<1||r>s.search.pager.totalPages||e.search.handleSearch(r)},s.search.getOrgTypes=function(){o.getOrgTypeS().then(function(e){s.search.orgTypes=e})},s.search.getOrgTypes(),s.search.getSelectedContentTypeValue=function(e,s){var r=_.filter(e,function(e){return e.key===s});return r?r[0].value:""},s.lineInView=function(e,r,a,c){var t=_.filter(s.inviewLogs,function(e){return e.objid===a.identifier});!0===r&&0===t.length&&s.inviewLogs.push({objid:a.identifier,objtype:c,index:e}),u.setVisitData(s.inviewLogs)}}]);