"use strict";angular.module("playerApp").controller("courseScheduleCtrl",["$rootScope","$stateParams","courseService","toasterService","$timeout","contentStateService","$scope","$location","batchService","dataService","sessionService","$anchorScroll","permissionsService","$state","telemetryService","$window",function(e,t,n,o,s,r,a,c,i,u,d,l,m,p,C,h){var g=this;g.isTelemtryStarted=!1,g.getCourseToc=function(){g.loader=o.loader("",e.messages.stmsg.m0003),n.courseHierarchy(g.courseId).then(function(t){if(t&&"OK"===t.responseCode){if("Live"!==t.result.content.status&&"Unlisted"!==t.result.content.status&&"Flagged"!==t.result.content.status){g.loader.showLoader=!1,o.warning(e.messages.imsg.m0026);var n=JSON.parse(h.localStorage.getItem("previousURl"));return void p.go(n.name,n.params)}t.result.content.children=_.sortBy(t.result.content.children,["index"]),g.courseContents=g.getCourseContents(t.result.content,[]),g.courseTotal=g.courseContents.length,g.version=t.ver,g.contentCountByType=_.countBy(g.courseContents,"mimeType"),"ENROLLED_COURSE"===g.courseType?g.getContentState(function(){g.courseHierarchy=t.result.content,g.showBatchCardList()}):g.courseHierarchy=t.result.content}else o.error(e.messages.fmsg.m0003);g.loader.showLoader=!1}).catch(function(){g.loader.showLoader=!1,o.error(e.messages.fmsg.m0003)})},g.getContentState=function(e){var t={request:{userId:g.userId,courseIds:[g.courseId],contentIds:_.map(g.courseContents,"identifier")}};g.courseProgress=0,r.getContentsState(t,function(t){_.forEach(t,function(e){g.contentStatusList[e.contentId]=g.contentStatusClass[e.status]||g.contentStatusClass[0],2===e.status&&(g.courseProgress+=1)}),e()})},g.getCourseContents=function(e,t){return"application/vnd.ekstep.content-collection"!==e.mimeType?t.push(e):angular.forEach(e.children,function(n,o){g.getCourseContents(e.children[o],t)}),t},g.scrollToPlayer=function(){c.hash(g.hashId),s(function(){l("tocPlayer")},500)},g.initTocView=function(){s(function(){$(".toc-tree-item").fancytree({click:function(e,t){"title"===t.targetType&&(t.targetType="expander",g.openContent(t.node.key))}}),$(".ui.accordion").accordion({exclusive:!1}),$(".fancytree-container").addClass("fancytree-connectors"),g.openRecentCollection()},100)},g.openRecentCollection=function(){s(function(){g.itemIndex>=0&&$(".fancy-tree-container").each(function(){var t=this.id;$(this).fancytree("getTree").visit(function(n){n.key===e.contentId?(s(function(){$("#"+t).closest(".accordion").find(".title").hasClass("active")||$("#"+t).closest(".accordion").find(".title").trigger("click"),n.setActive(!1)},10),n.setExpanded(!0),n.setActive(!0),n.setFocus(!1),$("#resume-button-"+g.itemIndex).removeClass("contentVisibility-hidden")):(n.setActive(!1),n.setFocus(!1))})})},100)},g.getContentIcon=function(e,t){return t=t||"",{"application/pdf":"/common/images/pdf"+t+".png","video/mp4":"/common/images/video"+t+".png","video/webm":"/common/images/video"+t+".png","video/x-youtube":"/common/images/video"+t+".png","video/youtube":"/common/images/video"+t+".png","application/vnd.ekstep.html-archive":"/common/images/app"+t+".png","application/vnd.ekstep.ecml-archive":"/common/images/app"+t+".png","application/epub":"/common/images/app"+t+".png","application/vnd.ekstep.h5p-archive":"/common/images/video"+t+".png","application/vnd.ekstep.content-collection":"/common/images/folder.png"}[e]},g.expandAccordion=function(e){var t=$(e.target).closest(".title").find("i");g.updateAccordionIcon(t,!$(t).hasClass("plus"))},g.updateAccordionIcon=function(e,t){t?$(e).addClass("plus").removeClass("minus"):$(e).addClass("minus").removeClass("plus")},g.updateCourseProgress=function(){s(function(){var e=parseInt(100*g.courseProgress/g.courseTotal,10);$("#tocProgress").progress({percent:e})},500);var t=_.find(e.enrolledCourses,{courseId:g.courseId});t&&g.itemIndex>=0&&(t.lastReadContentId=g.courseContents[g.itemIndex].identifier,e.enrolledCourseIds[g.courseId].lastReadContentId=t.lastReadContentId,t.progress=g.courseProgress,e.enrolledCourseIds[g.courseId].progress=t.progress)},a.$watch("contentPlayer.isContentPlayerEnabled",function(e,t){$(".toc-resume-button").addClass("contentVisibility-hidden"),!0===t&&!1===e&&(g.hashId="",c.hash(g.hashId),g.getContentState(function(){g.updateCourseProgress()}),g.updateBreadCrumbs())}),g.batchCardShow=!0,g.batchDetailsShow=!1,g.showBatchCardList=function(){var n=_.find(e.enrolledCourses,function(e){return e.courseId===g.courseId});_.isUndefined(n)||(g.batchCardShow=!1,i.getBatchDetails({batchId:n.batchId}).then(function(n){n&&"OK"===n.responseCode&&!_.isEmpty(n.result.response)&&(g.batchDetailsShow=!0,g.selectedBatchInfo=n.result.response,e.batchHashTagId=n.result.response.hashtagid,g.selectedParticipants=_.isUndefined(g.selectedBatchInfo.participant)?0:_.keys(g.selectedBatchInfo.participant).length,g.batchStatus=g.selectedBatchInfo.status,g.batchStatus&&g.batchStatus>0&&"Flagged"!==g.courseHierarchy.status&&(g.playContent=!0,g.batchStatus<2&&!u.getData("contentStateInit")&&e.isTocPage&&(r.init(),u.setData("contentStateInit",!0),u.setData("isTrackingEnabled",!0)),e.isTocPage&&"no"===t.lectureView&&g.resumeCourse()))}).catch(function(){o.error(e.messages.fmsg.m0054)}))},g.openContent=function(t,n){if(!0===g.playContent){g.itemIndex=_.findIndex(g.courseContents,{identifier:t});var o=g.courseContents[g.itemIndex];o&&"application/vnd.ekstep.content-collection"!==o.mimeType&&(g.prevPlaylistItem=g.itemIndex-1>-1?g.courseContents[g.itemIndex-1].identifier:-1,g.nextPlaylistItem=g.itemIndex+1<g.courseContents.length?g.courseContents[g.itemIndex+1].identifier:-1,g.previousPlayListName=g.itemIndex-1>-1?g.courseContents[g.itemIndex-1].name:"No content to play",g.nextPlayListName=g.itemIndex+1<g.courseContents.length?g.courseContents[g.itemIndex+1].name:"No content to play",e.contentId=t,a.contentPlayer.contentData=o,a.contentPlayer.isContentPlayerEnabled=!0,g.hashId="tocPlayer/"+t+"/"+g.itemIndex,g.objRollup=[t],g.scrollToPlayer(),g.updateBreadCrumbs())}},g.updateBreadCrumbs=function(){if(e.breadCrumbsData=[{name:"Home",link:"home"},{name:"Courses",link:"learn"},{name:g.courseHierarchy.name,link:"/course//"+g.courseId+"/"+g.lectureView}],a.contentPlayer.isContentPlayerEnabled){var n=g.courseContents[g.itemIndex].name;g.courseParams={},g.courseParams.contentName=n,g.courseParams.contentId=e.contentId,g.courseParams.contentIndex=g.itemIndex,g.courseParams.courseId=g.courseId,g.courseParams.lectureView=t.lectureView;var o={name:n,link:""};d.setSessionData("COURSE_PARAMS",g.courseParams),e.breadCrumbsData[3]?e.breadCrumbsData[3]=o:e.breadCrumbsData.push(o)}},g.resumeCourse=function(){if(g.showCourseDashboard=!1,!1===g.isTelemtryStarted&&(C.startTelemetryData("course",g.courseId,"course","1.0","player","course-read","play"),g.isTelemtryStarted=!0,u.setData("isTelemtryStarted",!0)),g.courseContents.length>0)if(e.isTocPage)if(c.hash().indexOf("tocPlayer")<0){var n=t.lastReadContentId||g.courseContents[0].identifier;g.openContent(n),g.objRollup=[n]}else{var o=c.hash().toString().split("/");g.openContent(o[1])}else{var s=d.getSessionData("COURSE_PARAMS");d.setSessionData("COURSE_PARAMS",s),p.go("Toc",s)}},g.init=function(){g.courseId=t.courseId,g.courseType=e.enrolledCourseIds[g.courseId]?"ENROLLED_COURSE":"OTHER_COURSE",g.playContent=!1,g.contentStatusList={},g.contentStatusClass={0:"grey",1:"blue",2:"green"},g.userId=e.userId,a.contentPlayer={isContentPlayerEnabled:!1},g.showNoteInLecture=!0,g.itemIndex=-1,g.showCourseDashboard=!1,g.isCourseMentor=!1,-1!==m.getCurrentUserRoles().indexOf("COURSE_MENTOR")&&(g.isCourseMentor=!0),g.getCourseToc()},g.initDropdownValues=function(){$("#courseDropdownValues").dropdown()},$("#courseDropdownValues").dropdown("restore defaults"),g.generateInteractEvent=function(e,t,n,o,s,r,a){C.interactTelemetryData(e,t,n,o,s,r,a)}}]);
