"use strict";angular.module("playerApp").controller("ContentEditorController",["config","$stateParams","toasterService","$state","contentService","$timeout","$rootScope","workSpaceUtilsService","$window","searchService",function(e,t,n,o,r,a,i,d,s,c){var l=this;l.contentId=t.contentId,l.framework=t.framework;var p=JSON.parse(s.localStorage.getItem("previousURl"));l.openContentEditor=function(){window.context={user:{id:i.userId,name:i.firstName+" "+i.lastName},sid:i.sessionId,contentId:l.contentId,framework:l.framework,pdata:{id:org.sunbird.portal.appid,ver:"1.0",pid:"sunbird-portal"},tags:_.concat([],org.sunbird.portal.channel),channel:org.sunbird.portal.channel},window.config={baseURL:"",modalId:"contentEditor",apislug:"/action",alertOnUnload:!0,headerLogo:_.isUndefined(i.orgLogo)?"":i.orgLogo,aws_s3_urls:["https://s3.ap-south-1.amazonaws.com/ekstep-public-"+org.sunbird.portal.ekstep_env+"/","https://ekstep-public-"+org.sunbird.portal.ekstep_env+".s3-ap-south-1.amazonaws.com/"],plugins:[{id:"org.ekstep.sunbirdcommonheader",ver:"1.4",type:"plugin"},{id:"org.ekstep.metadata",ver:"1.0",type:"plugin"},{id:"org.ekstep.sunbirdmetadata",ver:"1.0",type:"plugin"},{id:"org.ekstep.questionset",ver:"1.0",type:"plugin"}],dispatcher:"local",localDispatcherEndpoint:"/content-editor/telemetry",showHelp:!1,previewConfig:{repos:["/content-plugins/renderer"],plugins:[{id:"org.sunbird.player.endpage",ver:1,type:"plugin"}],showEndPage:!1}},c.updateReqForChannelFilter()&&(window.config.searchCriteria=c.updateReqForChannelFilter()),$("#contentEditor").iziModal({title:"",iframe:!0,iframeURL:"/thirdparty/bower_components/content-editor-iframe/index.html",navigateArrows:!1,fullscreen:!1,openFullscreen:!0,closeOnEscape:!1,overlayClose:!1,overlay:!1,overlayColor:"",history:!1,onClosed:function(){l.openModel()}}),a(function(){$("#contentEditor").iziModal("open")},100)};var u={state:["WorkSpace.UpForReviewContent","WorkSpace.ReviewContent","WorkSpace.PublishedContent","LimitedPublishedContent"],status:["Review","Draft","Live","Unlisted","FlagDraft","FlagReview"],mimeType:e.CreateLessonMimeType};l.checkContentAccess=function(e,t){var n=e.status,o=e.createdBy,r=e.state,a=e.userId,i=t.status;if(e.mimeType===t.mimeType){var d=_.indexOf(i,n)>-1,s=_.indexOf(t.state,r)>-1;return!(!d||!s||o===a)||(!(!d||!s||o!==a)||!(!d||o!==a))}return!1},l.getContentData=function(){var e={contentId:l.contentId},a={fields:"createdBy,status,mimeType",mode:"edit"};r.getById(e,a).then(function(e){if(e&&"OK"===e.responseCode){var r=e.result.content;r.state=t.state,r.userId=i.userId,l.checkContentAccess(r,u)?l.openContentEditor():(n.warning(i.messages.imsg.m0004),o.go(p.name,p.params))}else n.warning(i.messages.imsg.m0004),o.go(p.name,p.params)})},l.init=function(){org.sunbird.portal.eventManager.addEventListener("sunbird:portal:editor:close",function(){t.state?o.go(t.state):o.go("WorkSpace.DraftContent")}),org.sunbird.portal.eventManager.addEventListener("sunbird:portal:content:review",function(e,n){t.state?o.go(t.state):o.go("WorkSpace.DraftContent")}),window.addEventListener("editor:metadata:edit",function(e,t){org.sunbird.portal.eventManager.dispatchEvent("sunbird:portal:editor:editmeta")}),window.addEventListener("editor:window:close",function(e,t){org.sunbird.portal.eventManager.dispatchEvent("sunbird:portal:editor:close")}),window.addEventListener("editor:content:review",function(e,t){org.sunbird.portal.eventManager.dispatchEvent("sunbird:portal:content:review",e.detail.contentId)})},l.init(),l.getContentData(),i.$on("$stateChangeStart",function(e,t,n,o){if("ContentEditor"===o.name){"opened"===$("#contentEditor").iziModal("getState")&&document.getElementById("contentEditor").remove()}}),l.openModel=function(){l.showModal=!0,$("#modalContentEditor").modal("show"),a(function(){d.hideRemoveModel("#modalContentEditor"),document.getElementById("contentEditor")&&document.getElementById("contentEditor").remove(),document.getElementById("modalContentEditor")&&document.getElementById("modalContentEditor").remove(),l.showModal=!1,t.state?o.go(t.state):o.go("WorkSpace.DraftContent")},2e3)}}]);