"use strict";angular.module("playerApp").controller("CollectionEditorController",["config","$stateParams","toasterService","$sce","$state","$timeout","$rootScope","contentService","permissionsService","workSpaceUtilsService","$window","searchService",function(e,o,t,i,n,l,a,r,d,s,c,p){var f=this;f.contentId=o.contentId,f.framework=o.framework,f.openCollectionEditor=function(e){$("#collectionEditor").iziModal({title:"",iframe:!0,iframeURL:"/thirdparty/bower_components/collection-editor-iframe/index.html",navigateArrows:!1,fullscreen:!1,openFullscreen:!0,closeOnEscape:!1,overlayClose:!1,overlay:!1,history:!1,overlayColor:"",onClosed:function(){f.openModel()}}),window.context={user:{id:a.userId,name:a.firstName+" "+a.lastName},sid:a.sessionId,contentId:f.contentId,pdata:{id:org.sunbird.portal.appid,ver:"1.0",pid:"sunbird-portal"},tags:_.concat([],org.sunbird.portal.channel),channel:org.sunbird.portal.channel,framework:f.framework,env:e.type.toLowerCase()},window.config={corePluginsPackaged:!0,modalId:"collectionEditor",dispatcher:"local",apislug:"/action",alertOnUnload:!0,headerLogo:_.isUndefined(a.orgLogo)?"":a.orgLogo,loadingImage:"",plugins:[{id:"org.ekstep.sunbirdcommonheader",ver:"1.4",type:"plugin"},{id:"org.ekstep.lessonbrowser",ver:"1.3",type:"plugin"},{id:"org.ekstep.metadata",ver:"1.0",type:"plugin"},{id:"org.ekstep.sunbirdmetadata",ver:"1.0",type:"plugin"}],localDispatcherEndpoint:"/collection-editor/telemetry",editorConfig:{mode:"Edit",contentStatus:"draft",rules:{levels:7,objectTypes:f.getTreeNodes(e.type)},defaultTemplate:{}},previewConfig:{repos:["/content-plugins/renderer"],plugins:[{id:"org.sunbird.player.endpage",ver:1,type:"plugin"}],showEndPage:!1},editorType:e.type},p.updateReqForChannelFilter()&&(window.config.searchCriteria=p.updateReqForChannelFilter()),"textbook"===e.type.toLowerCase()?(window.config.plugins.push({id:"org.ekstep.suggestcontent",ver:"1.0",type:"plugin"}),window.config.nodeDisplayCriteria={contentType:["TextBookUnit"]}):"course"===e.type.toLowerCase()?window.config.nodeDisplayCriteria={contentType:["CourseUnit"]}:"lessonplan"===e.type.toLowerCase()?window.config.nodeDisplayCriteria={contentType:["LessonPlanUnit"]}:window.config.nodeDisplayCriteria={contentType:["Collection"]},window.config.editorConfig.publishMode=!1,window.config.editorConfig.isFlagReviewer=!1,"WorkSpace.UpForReviewContent"===o.state&&_.intersection(d.getCurrentUserRoles(),["CONTENT_REVIEWER","CONTENT_REVIEW","BOOK_REVIEWER","FLAG_REVIEWER"]).length>0?window.config.editorConfig.publishMode=!0:"WorkSpace.FlaggedContent"===o.state&&_.intersection(d.getCurrentUserRoles(),["FLAG_REVIEWER"]).length>0&&(window.config.editorConfig.isFlagReviewer=!0);var i={state:["WorkSpace.UpForReviewContent","WorkSpace.ReviewContent","WorkSpace.PublishedContent","WorkSpace.FlaggedContent","LimitedPublishedContent"],status:["Review","Draft","Live","Flagged","Unlisted","FlagDraft","FlagReview"],mimeType:"application/vnd.ekstep.content-collection"},s={contentId:f.contentId},c={fields:"createdBy,status,mimeType",mode:"edit"};"WorkSpace.FlaggedContent"===o.state&&delete c.mode,r.getById(s,c).then(function(e){if(e&&"OK"===e.responseCode){var r=e.result.content;r.state=o.state,r.userId=a.userId,f.validateRequest(r,i)?(f.updateModeAndStatus(e.result.content.status),l(function(){$("#collectionEditor").iziModal("open")},100)):(t.warning(a.messages.imsg.m0004),n.go("Home"))}})},f.validateRequest=function(e,o){var t=e.status,i=e.createdBy,n=e.state,l=e.userId,a=o.status;if(e.mimeType===o.mimeType){var r=_.indexOf(a,t)>-1,d=_.indexOf(o.state,n)>-1;return!(!r||!d||i===l)||(!(!r||!d||i!==l)||!(!r||i!==l))}return!1},f.getTreeNodes=function(e){var o=[];switch(e){case"Course":return o.push({type:"Course",label:"Course",isRoot:!0,editable:!0,childrenTypes:["CourseUnit","Collection","Resource"],addType:"Editor",iconClass:"fa fa-book"},{type:"CourseUnit",label:"Course Unit",isRoot:!1,editable:!0,childrenTypes:["CourseUnit","Collection","Resource"],addType:"Editor",iconClass:"fa fa-folder-o"},{type:"Collection",label:"Collection",isRoot:!1,editable:!1,childrenTypes:[],addType:"Browser",iconClass:"fa fa-file-o"},{type:"Resource",label:"Resource",isRoot:!1,editable:!1,childrenTypes:[],addType:"Browser",iconClass:"fa fa-file-o"}),o;case"Collection":return o.push({type:"Collection",label:"Collection",isRoot:!0,editable:!0,childrenTypes:["Collection","Resource"],addType:"Editor",iconClass:"fa fa-folder-o"},{type:"Collection",label:"Collection",isRoot:!1,editable:!1,childrenTypes:[],addType:"Browser",iconClass:"fa fa-file-o"},{type:"Resource",label:"Resource",isRoot:!1,editable:!1,childrenTypes:[],addType:"Browser",iconClass:"fa fa-file-o"}),o;case"LessonPlan":return o.push({type:"LessonPlan",label:"LessonPlan",isRoot:!0,editable:!0,childrenTypes:["LessonPlanUnit","Collection","Resource"],addType:"Editor",iconClass:"fa fa-book"},{type:"LessonPlanUnit",label:"LessonPlan Unit",isRoot:!1,editable:!0,childrenTypes:["LessonPlanUnit","Collection","Resource"],addType:"Editor",iconClass:"fa fa-folder-o"},{type:"Collection",label:"Collection",isRoot:!1,editable:!1,childrenTypes:[],addType:"Browser",iconClass:"fa fa-file-o"},{type:"Resource",label:"Resource",isRoot:!1,editable:!1,childrenTypes:[],addType:"Browser",iconClass:"fa fa-file-o"}),o;default:return o.push({type:"TextBook",label:"Textbook",isRoot:!0,editable:!0,childrenTypes:["TextBookUnit","Collection","Resource"],addType:"Editor",iconClass:"fa fa-book"},{type:"TextBookUnit",label:"Textbook Unit",isRoot:!1,editable:!0,childrenTypes:["TextBookUnit","Collection","Resource"],addType:"Editor",iconClass:"fa fa-folder-o"},{type:"Collection",label:"Collection",isRoot:!1,editable:!1,childrenTypes:[],addType:"Browser",iconClass:"fa fa-file-o"},{type:"Resource",label:"Resource",isRoot:!1,editable:!1,childrenTypes:[],addType:"Browser",iconClass:"fa fa-file-o"}),o}},f.updateModeAndStatus=function(e){"draft"===e.toLowerCase()&&(window.config.editorConfig.mode="Edit",window.config.editorConfig.contentStatus="draft"),"review"===e.toLowerCase()&&(window.config.editorConfig.mode="Read",window.config.editorConfig.contentStatus="draft"),"live"===e.toLowerCase()&&(window.config.editorConfig.mode="Edit",window.config.editorConfig.contentStatus="live"),"flagged"===e.toLowerCase()&&(window.config.editorConfig.mode="Read",window.config.editorConfig.contentStatus="flagged")},f.openCollectionEditor(o),a.$on("$stateChangeStart",function(e,o,t,i){if("CollectionEditor"===i.name){"opened"===$("#collectionEditor").iziModal("getState")&&document.getElementById("collectionEditor")&&document.getElementById("collectionEditor").remove()}}),f.openModel=function(){f.showModal=!0,$("#modalCollectionEditor").modal("show"),l(function(){s.hideRemoveModel("#modalCollectionEditor"),document.getElementById("collectionEditor")&&document.getElementById("collectionEditor").remove(),document.getElementById("modalCollectionEditor")&&document.getElementById("modalCollectionEditor").remove(),f.showModal=!1,o.state?n.go(o.state):n.go("WorkSpace.DraftContent")},2e3)}}]);