"use strict";angular.module("playerApp").controller("BatchController",["$rootScope","$timeout","$state","$scope","$stateParams","batchService","$filter","permissionsService","toasterService","courseService","learnService","$window","userService","telemetryService",function(e,t,r,s,a,n,o,i,c,d,u,l,h,m){var f=this;f.userList=[],f.menterList=[],f.userId=e.userId,f.courseId=a.courseId,f.coursecreatedby=a.coursecreatedby,f.submitted=!1,f.showBatchCard=s.showbatchcard,f.quantityOfBatchs=3,f.isMentor=!1,f.status=1,f.batchInfo="",f.statusOptions=[{name:"Ongoing",value:1},{name:"Upcoming",value:0}],f.showEnroll=!0,f.searchUserMap={},f.userSearchTime=0,f.showCreateBatchModal=function(){f.getUserList(),t(function(){f.data={enrollmentType:"invite-only"},$('input:radio[name="enrollmentType"]').filter('[value="invite-only"]').attr("checked",!0),$("#users,#mentors").dropdown({forceSelection:!1,fullTextSearch:!0}),$(".ui.calendar").calendar({refresh:!0}),$("#createBatchModal").modal({closable:!1,onShow:function(){var e=new Date;$(".ui.calendar#rangestartAdd").calendar({type:"date",minDate:new Date(e.setDate(e.getDate())),formatter:{date:function(e,t){return o("date")(e,"yyyy-MM-dd")}},onChange:function(e,t,r){_.isUndefined(f)?f={data:{startDate:t}}:_.isUndefined(f.data)?f.data={startDate:t}:f.data.startDate=t,$(".ui.calendar#rangeendAdd").calendar({type:"date",minDate:new Date(e.getFullYear(),e.getMonth(),e.getDate()+1),formatter:{date:function(e,t){return o("date")(e,"yyyy-MM-dd")}},onChange:function(e,t,r){_.isUndefined(f)?f={data:{endDate:t}}:_.isUndefined(f.data)?f.data={endDate:t}:f.data.endDate=t}})}}),$(".ui.calendar#rangeendAdd").calendar({type:"date",minDate:new Date(e.setDate(e.getDate()+1)),formatter:{date:function(e,t){return o("date")(e,"yyyy-MM-dd")}},startCalendar:$(".ui.calendar#rangestartAdd")}),$(".ui.modal.transition.hidden").remove()},onHide:function(){var e=JSON.parse(window.localStorage.getItem("previousURl"));r.go(e.name,e.params)}}).modal("show")},10)},f.hideCreateBatchModal=function(){$("#createBatchModal").modal("hide"),$("#createBatchModal").modal("hide others"),$("#createBatchModal").modal("hide dimmer")},f.addBatch=function(r){if(s.createBatch.$valid){"open"!==r.enrollmentType?(r.users=$("#users").dropdown("get value").split(","),r.mentors=$("#mentors").dropdown("get value").split(",")):(r.users=[],r.mentors=[]);var a={request:{courseId:f.courseId,name:r.name,description:r.description,enrollmentType:r.enrollmentType,startDate:r.startDate,endDate:r.endDate,createdBy:f.userId,createdFor:e.organisationIds,mentors:_.compact(r.mentors)}};n.create(a).then(function(s){if(s&&"OK"===s.responseCode)if(r.users&&r.users.length>0){var a={request:{userIds:_.compact(r.users)}};t(function(){n.addUsers(a,s.result.batchId).then(function(t){t&&"OK"===t.responseCode?(f.getCouserBatchesList(),f.hideCreateBatchModal()):c.error(e.messages.fmsg.m0053)}).catch(function(){c.error(e.messages.fmsg.m0053)})},100)}else f.hideCreateBatchModal();else c.error(e.messages.fmsg.m0052)}).catch(function(){c.error(e.messages.fmsg.m0052)})}},f.clearBatchData=function(){$("#createBatch").form("clear"),$("#createBatch").find(".search").val("")},f.getCouserBatchesList=function(){var t={request:{filters:{courseId:f.courseId},sort_by:{createdDate:"desc"}}};t.request.filters.status=_.isUndefined(f.status)?"1":f.status.toString(),_.intersection(i.getCurrentUserRoles(),["COURSE_MENTOR"]).length>0?(f.isMentor=!0,t.request.filters.createdBy=f.userId):t.request.filters.enrollmentType="open",n.getAllBatchs(t).then(function(t){if(t&&"OK"===t.responseCode)if(f.userList=[],f.userNames={},_.forEach(t.result.response.content,function(e){f.userList.push(e.createdBy)}),f.userList=_.compact(_.uniq(f.userList)),f.userList.length>0){var r={request:{filters:{identifier:f.userList}}};n.getUserList(r).then(function(r){r&&"OK"===r.responseCode?(_.forEach(r.result.response.content,function(e){f.userNames[e.identifier]=e}),f.batchList=t.result.response.content||[]):c.error(e.messages.fmsg.m0056)}).catch(function(){c.error(e.messages.fmsg.m0056)})}else f.batchList=t.result.response.content||[];else c.error(e.messages.fmsg.m0004)}).catch(function(){c.error(e.messages.fmsg.m0004)})},f.showUpdateBatchModal=function(e,t){n.setBatchData(e),r.go("updateBatch",{batchId:e.identifier,coursecreatedby:t})},t(function(){$("#users").dropdown({forceSelection:!1,fullTextSearch:!0,onAdd:function(){$("#createBatchModal").modal("refresh"),f.isUserSearch=1,f.getUserListWithQuery("")}}),$("#mentors").dropdown({fullTextSearch:!0,forceSelection:!1,onAdd:function(){$("#createBatchModal").modal("refresh"),f.isUserSearch=2,f.getUserListWithQuery("")}}),$("#users input.search").on("keyup",function(e){f.isUserSearch=1,f.getUserListWithQuery(this.value)}),$("#mentors input.search").on("keyup",function(e){f.isUserSearch=2,f.getUserListWithQuery(this.value)})},1e3),f.getUserListWithQuery=function(e){f.userSearchTime&&clearTimeout(f.userSearchTime),f.userSearchTime=setTimeout(function(){var t=f.searchUserMap[e];t?(f.isUserSearch=0,f.userList=t.user,f.menterList=t.mentor,$("#users").dropdown("refresh"),$("#mentors").dropdown("refresh")):f.getUserList(e)},1e3)},f.getUserList=function(t){var r=n.getRequestBodyForUserSearch(t);n.getUserList(r).then(function(r){r&&"OK"===r.responseCode?(_.forEach(r.result.response.content,function(r){if(r.identifier!==e.userId&&n.filterUserSearchResult(r,t)){var s={id:r.identifier,name:r.firstName+(r.lastName?" "+r.lastName:""),avatar:r.avatar,otherDetail:n.getUserOtherDetail(r)};_.forEach(r.organisations,function(e){-1!==_.indexOf(e.roles,"COURSE_MENTOR")&&f.menterList.push(s)}),f.userList.push(s)}}),f.userList=_.uniqBy(f.userList,"id"),f.menterList=_.uniqBy(f.menterList,"id"),f.searchUserMap[t||""]={mentor:_.clone(f.menterList),user:_.clone(f.userList)},$("#users").dropdown("refresh"),$("#mentors").dropdown("refresh"),f.isUserSearch=0):(f.isUserSearch=0,c.error(e.messages.fmsg.m0056))}).catch(function(){f.isUserSearch=0,c.error(e.messages.fmsg.m0056)})},f.showBatchDetails=function(t){if(f.participants={},_.isUndefined(t.participant))e.$broadcast("batchDetails",t),$("#batchDetails").modal("show");else{var r={request:{filters:{identifier:_.keys(t.participant)}}};n.getUserList(r).then(function(r){r&&"OK"===r.responseCode?(_.forEach(r.result.response.content,function(e){f.participants[e.identifier]=e}),t.userList=f.participants,console.log("batchData ",t),e.$broadcast("batchDetails",t),$("#batchDetails").modal("show")):c.error(e.messages.fmsg.m0056)}).catch(function(){c.error(e.messages.fmsg.m0056)})}},f.enrollUserToCourse=function(r){var s={request:{courseId:f.courseId,userId:f.userId,batchId:r}};d.enrollUserToCourse(s).then(function(r){r&&"OK"===r.responseCode?(f.showEnroll=!1,c.success(e.messages.smsg.m0036),t(function(){l.location.reload()},2e3)):c.error(e.messages.emsg.m0001)}).catch(function(){c.error(e.messages.emsg.m0001)})}}]);