"use strict";angular.module("playerApp").controller("DataDrivenFiltersController",["$scope","config","$rootScope","$timeout","$state","$stateParams","searchService","toasterService","$location","sessionService","adminService","permissionsService","PaginationService","telemetryService",function(e,r,s,a,c,t,o,n,h,i,l,u,d,g){function y(e,r,s,a){var c={};return c.showError=!0,c.isClose=e,c.message=r,c.messageType=s,a&&(c.messageText=a),c}var f=this;e.search={},f.search={},f.search.searchKeyword="",f.search.filters={},f.search.contentTypes=r.FILTER.RESOURCES.contentTypes,f.search.sortingOptions=r.sortingOptions,f.search.sortBy={createdOn:"asc"},f.search.sortIcon=!0,f.search.selectedLanguage=[],f.search.selectedContentType=[],f.search.sortByOption={},f.inviewLogs=[],f.dropdownId=[],f.dropdownValue=[],f.search.showFilters=!1,f.applyFilterOnly=!1;var p=s.$on("DynsetSearchKey",function(e,r){f.search.selectedSearchKey=r.key;var s={type:"content",action:"search"};switch(f.search.selectedSearchKey){case"Courses":s.subType="course",f.getChannel(s);break;case"Library":s.subType="library",f.getChannel(s)}}),m=s.$on("DynSearchKey",function(e,r){switch(f.searchKey=r.key,f.search.selectedSearchKey=f.searchKey,f.req={type:"content",action:"search"},f.search.selectedSearchKey){case"Courses":f.req.subType="course",f.getChannel(f.req);break;case"Library":f.req.subType="library",f.getChannel(f.req)}}),S=s.$on("initSearch",function(r,s){!1===f.applyFilterOnly&&e.search.initSearch()});f.search.selectFilter=function(e,r,s){a(function(){var a=f.search[e].indexOf(r);-1===a?(f.search[e].push(r),$(s.target).addClass("active")):(f.search[e].splice(a,1),$(s.target).removeClass("active"))},0)},f.getChannel=function(e){o.getChannel().then(function(e){"OK"===e.responseCode&&(f.frameworkId=e.result.channel.defaultFramework,o.getFramework(f.frameworkId).then(function(e){if("OK"===e.responseCode){f.req.framework=f.frameworkId;var r=_.cloneDeep(e.result.framework.categories);o.getDataDrivenFormsConfig(f.req).then(function(e){"OK"===e.responseCode?(f.search.showFilters=!0,f.formFieldProperties=_.sortBy(e.result.form.data.fields,["index"]),_.forEach(f.formFieldProperties,function(e){f.search["selected"+e.code]=[]}),f.formFieldProperties.sort(function(e,r){return e.index-r.index}),_.forEach(r,function(e){_.forEach(f.formFieldProperties,function(r){return e.code===r.code&&(r.category=e.terms),r})})):f.search.showFilters=!1}).catch(function(e){console.log("error is ......",e)})}}).catch(function(e){console.log("error is ......",e)}))}).catch(function(e){console.log("error is ......",e)})},f.search.dynamicSelectedSearch=function(e){return f.search["selected"+e]},f.search.removeFilterSelection=function(e,r){if("selectedConcepts"===e)f.search[e]=_.filter(f.search[e],function(e){return e.identifier!==r}),f.search.broadCastConcepts();else{var s=f.search[e].indexOf(r);-1!==s&&f.search[e].splice(s,1)}},f.getRoleName=function(e){return _.find(f.search.userRoles,{role:e}).roleName},f.getOrgName=function(e){return _.find(f.search.orgTypes,{id:e}).name},f.expandFilters=function(){$("#filterIcon").parents(".active").length<=0&&$("#filterIcon").trigger("click")},e.search.initSearch=function(){"Search"===c.current.name&&(f.isSearchPage=!0);var r=t;f.search.selectedSearchKey=f.searchKey||r.type,f.search.searchKeyword=f.search.searchKeyword||r.query,f.search.filters=JSON.parse(atob(r.filters||btoa("{}"))),f.search.sortBy=JSON.parse(atob(r.sort||btoa("{}"))),f.search.selectedContentType=f.search.filters.contentType||[],_.forEach(f.formFieldProperties,function(e){f.search["selected"+e.code]=f.search.filters[e.code]||[]}),f.search.broadCastConcepts(),f.search.sortByOption=Object.keys(f.search.sortBy).length>0?Object.keys(f.search.sortBy)[0]:"",f.search.searchFromSuggestion=t.autoSuggestSearch,e.search.searchRequest()},e.search.searchRequest=function(r){if(clearTimeout(f.search.typingTimer),!r||13===r.charCode)if(e.search.autoSuggest=!1,s.search.searchKeyword&&""!==s.search.searchKeyword||!s.isLearnPage&&!s.isResourcesPage||r){if(f.isSearchPage)if(s.isSearchResultsPage&&s.search.searchKeyword===t.query&&s.search.selectedSearchKey===t.type)s.search.error={},s.search.loader=n.loader("",s.messages.stmsg.m0005),e.search.handleSearch();else{e.search.autoSuggest=!1;var a={type:s.search.selectedSearchKey,query:s.search.searchKeyword,filters:btoa(JSON.stringify(f.search.filters)),autoSuggestSearch:s.search.searchFromSuggestion||!1};"null"!==_.keys(f.search.sortBy)[0]&&(a.sort=btoa(JSON.stringify(f.search.sortBy))),s.searchTelemetryId="search-"+s.search.selectedSearchKey.toLowerCase(),s.searchTelemetryPageid=s.search.selectedSearchKey.toLowerCase()+"-search",s.inviewLogs=[],c.go("Search",a,{reload:!0})}}else s.$broadcast("initPageSearchFromDynamicPage",{FilterData:f.search.filters,sortByData:f.search.sortBy})},e.search.handleSearch=function(r){r=r||1;var a={query:s.search.searchKeyword,filters:f.search.filters,sort_by:f.search.sortBy,offset:(r-1)*s.search.pageLimit,limit:s.search.pageLimit};if(e.search.autoSuggest&&!1!==e.search.autoSuggest||(s.search.loader||(s.search.loader=n.loader("",s.messages.stmsg.m0005)),s.search.loader.showLoader=!0),a.filters.concepts&&a.filters.concepts.length>0&&(a.filters.concepts=_.map(s.search.selectedConcepts,"identifier")),"true"===s.search.searchFromSuggestion?(a.filters.name=a.query,a.query="",s.search.searchFromSuggestion="false"):delete a.filters.name,"Courses"===s.search.selectedSearchKey)e.search.searchFn=o.courseSearch(a),e.search.resultType="course";else if("Library"===s.search.selectedSearchKey){var c=JSON.parse(JSON.stringify(a));(!a.filters.contentType||_.isArray(a.filters.contentType)&&0===a.filters.contentType.length)&&(c.filters.contentType=["Collection","TextBook","LessonPlan","Resource","Story","Worksheet","Game"]),e.search.searchFn=o.contentSearch(c),e.search.resultType="content",a.filters.objectType=["Content"]}e.search.searchFn.then(function(a){if(null===a||"OK"!==a.responseCode)throw s.search.loader.showLoader=!1,s.search.error=y(!0,s.messages.fmsg.m0004,s.messages.emsg.m0002),e.search.autoSuggest=!0,clearTimeout(s.search.typingTimer),new Error("");s.search.autosuggest_data=[];var c={};c="Organisations"===s.search.selectedSearchKey||"Users"===s.search.selectedSearchKey?a.result.response:a.result,e.search.autoSuggest&&s.search.searchKeyword!==t.query?(s.search.autosuggest_data=c[e.search.resultType]||[],s.search.autosuggest_data.length>0&&$("#search-suggestions").addClass("visible").removeClass("hidden")):(s.search.searchResultKeyword=s.search.searchKeyword,$("#search-suggestions").addClass("hidden").removeClass("visible"),s.search.loader.showLoader=!1,0===c.count?s.search.error=y(!0,s.messages.stmsg.m0006,s.messages.stmsg.m0008,s.messages.stmsg.m0007):(s.search.error={},s.search.searchResult=c,s.search.pager=d.GetPager(c.count,r,s.search.pageLimit))),e.search.autoSuggest=!0,clearTimeout(s.search.typingTimer)}).catch(function(e){s.search.loader.showLoader=!1,s.search.error=y(!0,s.messages.fmsg.m0004,s.messages.emsg.m0002)})};var C=e.$on("selectedConcepts",function(e,r){f.search.selectedConcepts=r.selectedConcepts});f.search.broadCastConcepts=function(){s.$broadcast("selectedConceptsFromSearch",{selectedConcepts:f.search.selectedConcepts})},f.search.applyFilter=function(){f.applyFilterOnly=!0,_.forEach(f.formFieldProperties,function(e){"select"!==e.inputType&&"multiselect"!==e.inputType||f.search["selected"+e.code].length&&(f.search.filters[e.code]=f.search["selected"+e.code])}),f.search.filters.concepts=f.search.selectedConcepts,f.search.filters.contentType=f.search.selectedContentType,s.isSearchResultsPage=!1,e.search.searchRequest()},f.search.resetFilter=function(){_.forEach(f.formFieldProperties,function(e){f.search["selected"+e.code].length&&(f.search["selected"+e.code]=[])}),f.search.selectedConcepts=[],f.search.selectedContentType=[],f.search.broadCastConcepts(),f.search.filters={},s.isSearchResultsPage=!1,f.isSearchPage=!0,e.search.searchRequest()},f.search.applySorting=function(){var r=f.search.sortByOption;f.search.sortBy={},f.search.sortBy[r]=!0===f.search.sortIcon?"asc":"desc",e.search.searchRequest()},e.$on("$destroy",function(){C(),S(),m(),p()}),f.search.getSelectedContentTypeValue=function(e,r){var s=_.filter(e,function(e){return e.key===r});return s?s[0].value:""},f.lineInView=function(e,r,s,a){var c=_.filter(f.inviewLogs,function(e){return e.objid===s.identifier});!0===r&&0===c.length&&f.inviewLogs.push({objid:s.identifier,objtype:a,index:e}),g.setVisitData(f.inviewLogs)}}]);