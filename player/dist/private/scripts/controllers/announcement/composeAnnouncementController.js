"use strict";angular.module("playerApp").controller("composeAnnouncementCtrl",["$rootScope","$scope","$state","$stateParams","$timeout","config","toasterService","fileUpload","AnnouncementModel","announcementAdapter","telemetryService",function(e,n,t,o,a,i,c,l,r,s,u){var d=this;d.targetIds=[],d.disableBtn=!0,d.showUrlField=!1,d.errorFlag=!1,d.isMetaModified=!1,d.announcementType=[],d.repeatableWebLinks=[],d.hideAnncmntBtn=!1,d.uploadAttchement=!1,d.editAction=!1,d.isApprove=!1,d.hideSendBtn=!1,d.config={geo:{adopter:"SERVICE",service:"geoService"}},d.initializeModal=function(){a(function(){$("#announcementType").dropdown({onChange:function(e,n,t){d.enableRecepientBtn()}})},100),e.$on("selected:items",function(e,n){d.announcement.selTar=_.clone(n.geo)})},d.createAnnouncement=function(){$("#createAnnouncementModal").modal({closable:!1,onShow:function(){$(".ui.modal.transition.hidden").remove()},onHide:d.onHideCreateAnnModal}).modal("show")},d.confirmationModal=function(){a(function(){$("#announcementCancelModal").modal({allowMultiple:!0,onDeny:function(){return!0},onApprove:d.onApproveConfirmationModal}).modal("show")},10)},d.hideModel=function(e){$("#"+e).modal("hide"),$("#"+e).modal("hide others"),$("#"+e).modal("hide all"),$("#"+e).modal("hide dimmer")},d.addNewLink=function(){var e=d.repeatableWebLinks.length+1;d.repeatableWebLinks.push({id:"choice"+e}),d.showUrlField=!0},d.removeLink=function(e){d.repeatableWebLinks.splice(e,1),d.announcement.links&&d.announcement.links.splice(e,1),d.showUrlField=!!d.repeatableWebLinks.length,d.enableRecepientBtn()},d.removeRecipients=function(n){_.remove(d.announcement.selTar,function(t){if(t.location===n.location)return n.selected=!1,c.info(n.location+" "+e.messages.imsg.m0020),t.location}),d.confirmRecipients()},d.confirmRecipients=function(){return e.$emit("get:selected:items"),!d.announcement.selTar||0!==d.announcement.selTar.length||(c.error(e.messages.emsg.m0006),!1)},d.enableRecepientBtn=function(e){if(void 0===e&&(e=!0),null!==d.announcement){var n=[];d.announcement.links&&angular.forEach(d.announcement.links,function(e,t){e.trim().length&&n.push(e)});var t=angular.element(document.querySelector("#selectRecipientBtn"));d.announcement.title&&d.announcement.from&&d.announcement.type&&(d.uploadAttchement||d.announcement.description||n.length)?(d.disableBtn=!1,t.removeClass("disabled")):(d.disableBtn=!0,t.addClass("disabled"))}d.isMetaModified=!1!==e},d.refreshFormValues=function(){d.disableBtn=!0,d.stepNumber=1,$("#announcementType").dropdown("restore defaults"),$("#createAnnouncementModal").modal("refresh"),d.isMetaModified=!1,d.repeatableWebLinks.length=0,d.showUrlField=!1,$(".qq-upload-list").children("li").remove()},d.saveAnnouncement=function(){d.editAction&&o.announcementId,d.isMetaModifiedSteps=!0,d.announcement.target.geo.ids=_.map(d.announcement.selTar,"id"),d.hideSendBtn=!0,d.endTelemetry(),s.createAnnouncement(d.announcement,d.editAction).then(function(n){d.hideSendBtn=!1,d.hideModel("createAnnouncementModal"),d.editAction?$("#announcementResendModal").modal({closable:!1}).modal("show"):$("#announcementSuccessModal").modal({closable:!1}).modal("show"),e.userIdHashTag=null,t.go("announcementOutbox")},function(e){d.isMetaModified=!0,d.hideSendBtn=!1,d.showError(e.data)})},d.showError=function(e){d.errorFlag=!0,"CLIENT_ERROR"===e.responseCode&&angular.isArray(e.params.errmsg)?angular.forEach(e.params.errmsg,function(e,n){c.error(e.description)}):c.error(e.params.errmsg)},d.getReadableFileSize=function(e){var n=["Bytes","KB","MB"];if(e){var t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));d.convertedFileSize=Math.round(e/Math.pow(1024,t),2)+" "+n[t]}else d.convertedFileSize="0 Byte";return d.convertedFileSize},window.removeCreateAnnAttachment=function(e,n,t){$(e).closest("li").remove(),d.onUploadCancel(n,t)},d.initializeFileUploader=function(n){var t={fileSizeLimit:i.AnncmntMaxFileSizeToUpload,allowedExtensions:i.AnncmntAllowedFileExtension,fileSizeErrorText:e.messages.emsg.m0007,containerName:"attachments/announcement",uploadSuccess:d.onUploadComplete,onCancel:d.onUploadCancel};l.createFineUploadInstance(t,d.prepopulateFilesCallback)},d.prepopulateFilesCallback=function(e){$(".qq-uploader").eq(1).parent().remove();var n=[];null!==d.announcement&&(n=d.announcement.attachments);var t=angular.copy(n);$("#old-file-list").length<=0&&($(".qq-upload-list").parent().prepend('<ul id="old-file-list" class=" qq-upload-list"></ul>'),_.forEach(t,function(e,n){var t="'"+e.name+"'";$("#old-file-list").append('<li class="qq-upload-retryable w3-container w3-border w3-round-xlarge qq-upload-success"> <i id="removeFile" onclick="removeCreateAnnAttachment (this,'+n+", "+t+')" class="remove icon cursor-pointer" style="float:right;"></i><span class="qq-upload-file-selector qq-upload-file" style="width: 200px;">'+e.name+"</span></li>"),d.uploadAttchement=!0})),d.enableRecepientBtn()},d.onUploadComplete=function(e,n,t){t.size=d.getReadableFileSize(t.size),d.announcement.attachments.push(t),d.uploadAttchement=!0,d.enableRecepientBtn()},d.onUploadCancel=function(e,n){0===d.announcement.attachments.splice(e,1).length&&angular.forEach(d.announcement.attachments,function(e,t){e.name===n&&d.announcement.attachments.splice(t,1)}),0===d.announcement.attachments.length&&(d.uploadAttchement=!1),d.enableRecepientBtn(),$("#hide-section-with-button").css("style.display","block")},d.init=function(){if(d.stepNumber=parseInt(o.stepNumber)||1,d.announcement=o.announcement,d.isMetaModifiedSteps=o.isMetaModifiedSteps,d.editAction=o.isResend,1===d.stepNumber&&d.initializeModal(),d.createAnnouncement(),1===d.stepNumber&&null===d.announcement&&(d.editAction?(d.getResend(o.announcementId),u.startTelemetryData("announcement",o.announcementId,"announcement","1.0","workflow","announcement-resend","edit")):(d.announcement=new r.Announcement({}),d.announcement.hideDate=!0,u.startTelemetryData("announcement","","announcement","1.0","workflow","announcement-create","edit"))),1===d.stepNumber&&(d.getDefinitions(e.rootOrgId),null!==d.announcement&&void 0!==d.announcement.links&&angular.forEach(d.announcement.links,function(e,n){d.addNewLink()})),2===d.stepNumber&&null!==d.announcement&&void 0!==d.announcement.target){var n=[];d.editAction?n=d.announcement.target.geo.ids:(d.announcement.target.geo.ids=_.map(d.announcement.selTar,"id"),n=_.map(d.announcement.selTar,"id")),a(function(){e.$broadcast("component:update",n)},100)}},d.goToNextStep=function(n,o){if(1!==d.stepNumber){if(!d.confirmRecipients())return!1;_.isEmpty(d.announcement.sourceId)&&(d.announcement.sourceId=e.rootOrgId)}d.isMetaModifiedSteps=!0,t.go(t.current.name,{stepNumber:++d.stepNumber,announcement:d.announcement,isMetaModifiedSteps:!1,telemetryPageId:n,telemetryPageType:o},{reload:!0})},d.goToBackStep=function(){d.isMetaModifiedSteps=!0,t.go(t.current.name,{stepNumber:--d.stepNumber,announcement:d.announcement,isMetaModifiedSteps:!1},{reload:!0})},d.getResend=function(e){s.getResend(e).then(function(e){d.announcement=new r.Announcement(e.result.announcement),d.announcement.hideDate=!0,d.initializeModal(),d.enableRecepientBtn(),d.initializeFileUploader(!0),null!==d.announcement&&void 0!==d.announcement.links&&angular.forEach(d.announcement.links,function(e,n){d.addNewLink()}),d.uploadAttchement=d.announcement.attachments.length>0})},d.getDefinitions=function(n){s.getDefinitions(n).then(function(e){e.result.announcementTypes&&(d.announcementType=_.map(e.result.announcementTypes,"name")),""!==d.announcement.type&&$("#announcementType").dropdown("set text",d.announcement.type)},function(n){n&&(d.hideAnncmntBtn=!0,c.error(e.messages.fmsg.m0069))})},d.onHideCreateAnnModal=function(){if(null===d.announcement&&!0!==d.isMetaModified?d.isMetaModified=!1:!0===d.isApprove?d.isMetaModified=!1:d.isMetaModified=!0,!0===d.isMetaModified&&!0!==d.isMetaModifiedSteps)return d.confirmationModal(),!1;!1===d.isMetaModified&&1===d.stepNumber&&(d.refreshFormValues(),t.go("announcementOutbox"))},d.onApproveConfirmationModal=function(){return d.isApprove=!0,d.refreshFormValues(),d.endTelemetry(),d.hideModel("announcementCancelModal"),t.go("announcementOutbox"),!0},d.endTelemetry=function(){d.editAction?u.endTelemetryData("announcement",o.announcementId,"announcement","1.0","workflow","announcement-resend","edit"):u.endTelemetryData("announcement","","announcement","1.0","workflow","announcement-create","edit")}}]);