"use strict";angular.module("playerApp").controller("PreviewContentController",["$stateParams","$rootScope","$state","contentService","$timeout","config","toasterService","$window",function(e,t,o,s,n,a,r,c){function i(e,t){var o=e.status,s=e.createdBy,n=e.state,a=e.userId,r=t.status;if(_.indexOf(t.mimeType,e.mimeType)>-1){var c=_.indexOf(r,o)>-1,i=_.indexOf(t.state,n)>-1;return!(!c||!i||s===a)||!(!c||!i||s!==a)||!(!c||s!==a)}return!1}function l(n){var a=n;if(a.state=e.backState,a.userId=t.userId,!i(a,m)){r.warning(t.messages.imsg.m0004);var l=JSON.parse(c.localStorage.getItem("previousURl"));o.go(l.name,l.params)}d.contentData=n,d.contentData.language=s.validateContent(d.contentData.language),d.contentData.gradeLevel=s.validateContent(d.contentData.gradeLevel),d.contentData.subject=s.validateContent(d.contentData.subject),d.contentData.flagReasons=s.validateContent(d.contentData.flagReasons),d.contentData.flaggedBy=s.validateContent(d.contentData.flaggedBy),d.contentData.flags=s.validateContent(d.contentData.flags),d.contentData.keywords=s.validateContent(d.contentData.keywords),d.contentPlayer.contentData=n,d.contentPlayer.isContentPlayerEnabled=!0}var d=this;d.contentProgress=0,d.contentId=e.contentId,d.userId=t.userId,d.isShowPublishRejectButton="WorkSpace.UpForReviewContent"===e.backState,d.isShowDeleteButton="WorkSpace.PublishedContent"===e.backState,d.isShowFlagActionButton="WorkSpace.FlaggedContent"===e.backState,d.checkListConfig=a.CHECK_LIST_CONFIG,d.contenteditmode=_.indexOf(["WorkSpace.UpForReviewContent","WorkSpace.ReviewContent"],e.backState)>-1;var m={state:["WorkSpace.UpForReviewContent","WorkSpace.ReviewContent","WorkSpace.PublishedContent","WorkSpace.FlaggedContent"],status:["Review","Live","Flagged","FlagDraft","FlagReview"],mimeType:a.MimeTypeExceptCollection};d.contentPlayer={isContentPlayerEnabled:!1},d.redirectUrl=e.backState,d.checkedContents=[],d.enableCheckListSubmitBtn=!1,d.reviewComments="",d.getContent=function(o){d.loader=r.loader("",t.messages.stmsg.m0025);var n={contentId:o},a={fields:"name,description,appIcon,contentType,mimeType,artifactUrl,versionKey,audience,language,gradeLevel,ageGroup,subject,medium,author,domain,createdBy,flagReasons,flaggedBy,flags,status,createdOn,lastUpdatedOn,body,board,keywords,resourceType,creator"};"WorkSpace.UpForReviewContent"!==e.backState&&"WorkSpace.ReviewContent"!==e.backState||(a.mode="edit"),s.getById(n,a).then(function(e){e&&"OK"===e.responseCode?(d.errorObject={},d.loader.showLoader=!1,l(e.result.content)):(d.loader.showLoader=!1,r.error(t.messages.fmsg.m0015))}).catch(function(){d.loader.showLoader=!1,r.error(t.messages.fmsg.m0015)})},d.getContent(d.contentId),d.publishContent=function(e){var o={content:{publishChecklist:d.checkedContents,lastPublishedBy:d.userId}};d.loader=r.loader("",t.messages.stmsg.m0029),s.publish(o,d.contentId).then(function(o){o&&"OK"===o.responseCode?(d.loader.showLoader=!1,d.isShowPublishRejectButton=!1,d.contentData.status="Live",r.success(t.messages.smsg.m0004),d.closeChecklistModal(e)):(d.loader.showLoader=!1,r.error(t.messages.fmsg.m0019),d.closeChecklistModal(e))}).catch(function(){d.loader.showLoader=!1,r.error(t.messages.fmsg.m0019),d.closeChecklistModal(e)})},d.showChecklistModal=function(e){$("#"+e).modal({closable:!1}).modal("show")},d.closeChecklistModal=function(e){$("#"+e).modal("hide"),d.enableCheckListSubmitBtn=!1,d.checkedContents=[],$(".listItem, .listPublishItem").attr("checked",!1),d.reviewComments=""},d.createCheckListArr=function(e){e&&-1===d.checkedContents.indexOf(e)?d.checkedContents.push(e):e&&-1!==d.checkedContents.indexOf(e)&&d.checkedContents.splice(d.checkedContents.indexOf(e),1)},d.validateRequestChecklistModal=function(e){d.createCheckListArr(e),$(".listItem:checked").length>0&&d.reviewComments.length>0?d.enableCheckListSubmitBtn=!0:d.enableCheckListSubmitBtn=!1},d.validatePublishtChecklistModal=function(e){d.createCheckListArr(e),$(".listPublishItem:checked").length===$(".listPublishItem").length?d.enableCheckListSubmitBtn=!0:d.enableCheckListSubmitBtn=!1},d.rejectContent=function(e){d.loader=r.loader("",t.messages.stmsg.m0030);var o={content:{rejectReasons:d.checkedContents,rejectComment:d.reviewComments}};s.reject(o,d.contentId).then(function(o){o&&"OK"===o.responseCode?(d.loader.showLoader=!1,d.isShowPublishRejectButton=!1,r.success(t.messages.smsg.m0005),d.closeChecklistModal(e)):(d.loader.showLoader=!1,r.error(t.messages.fmsg.m0020),d.closeChecklistModal(e))}).catch(function(){d.loader.showLoader=!1,r.error(t.messages.fmsg.m0020),d.closeChecklistModal(e)})},d.deleteContent=function(){d.loader=r.loader("",t.messages.stmsg.m0034);var a={contentIds:[d.contentId]};s.retire(a).then(function(s){s&&"OK"===s.responseCode?n(function(){d.loader.showLoader=!1,d.isShowDeleteButton=!1,d.isShowFlagActionButton=!1,r.success(t.messages.smsg.m0006),o.go(e.backState)},2e3):(d.loader.showLoader=!1,r.error(t.messages.fmsg.m0022))}).catch(function(){d.loader.showLoader=!1,r.error(t.messages.fmsg.m0022)})},d.acceptContentFlag=function(e){var o={versionKey:e.versionKey};d.loader=r.loader("",t.messages.stmsg.m0040),s.acceptContentFlag(o,e.identifier).then(function(e){e&&"OK"===e.responseCode?(d.loader.showLoader=!1,d.isShowFlagActionButton=!1,d.contentData.status="FlagDraft",r.success(t.messages.smsg.m0007)):(d.loader.showLoader=!1,r.error(t.messages.fmsg.m0024))}).catch(function(){d.loader.showLoader=!1,r.error(t.messages.fmsg.m0024)})},d.discardContentFlag=function(e){var o={};d.loader=r.loader("",t.messages.stmsg.m0041),s.discardContentFlag(o,e.identifier).then(function(e){e&&"OK"===e.responseCode?(d.loader.showLoader=!1,d.isShowFlagActionButton=!1,d.contentData.status="Live",r.success(t.messages.smsg.m0008)):(d.loader.showLoader=!1,r.error(t.messages.fmsg.m0025))}).catch(function(){d.loader.showLoader=!1,r.error(t.messages.fmsg.m0025)})},d.getConceptsNames=function(e){return s.getConceptsNames(e)},d.getResourceTypes=function(e){return!!e&&(_.isString(e)?e:!!_.isArray(e)&&e.join(", "))},$("#courseDropdownValues").dropdown("restore defaults")}]);