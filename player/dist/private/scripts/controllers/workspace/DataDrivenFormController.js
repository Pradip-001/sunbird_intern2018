"use strict";angular.module("playerApp").controller("DataDrivenFormController",["contentService","$timeout","$state","config","$rootScope","$scope","toasterService","searchService","configService","telemetryService",function(e,o,r,a,t,n,i,s,c,d){var u=this;u.categoryModelList={},u.formDropdown=c.getWorkspaceFormDropdown(),u.years=u.formDropdown.years,u.categoryList={},u.dropdownId=[],u.dropdownValue=[],u.selectedContent="",n.validation={},u.isSubmit=!1,u.mapMasterCategoryList=function(e,o){_.forEach(e,function(e,r){o?e.code===o&&(u.categoryList[e.code]=e.range):e.range&&(u.categoryList[e.code]=e.range)})},u.dispatchEvent=function(e,o){org.sunbird.portal.eventManager.dispatchEvent(e,o)},u.initDropdown=function(){},u.onConfigChange=function(e,o){u.isSubmit=!1,u.updateForm(o)},u.updateForm=function(e){e.field.range&&u.getAssociations(e.value,e.field.range,function(o){u.applyDependencyRules(e.field,o,!0)})},u.getAssociations=function(e,o,r){var a=[],t=[],n=[];_.isString(e)?a.push(e):a=e,_.filter(o,function(e){_.forEach(a,function(o,r){e.name===o&&n.push(e)})}),_.forEach(n,function(e,o){e.associations&&_.forEach(e.associations,function(e,o){t.push(e)})}),r&&r(t)},u.applyDependencyRules=function(e,o,r){var a,t;e.depends&&e.depends.length&&_.forEach(e.depends,function(e){r&&u.resetSelectedField(e),a=_.map(o,function(e){return _.pick(e,"name","category")}),t=_.chain(a).groupBy("category").map(function(e,o){return{name:e,category:o}}).value(),u.updateDropDownList(e,a),t.length?_.forEach(t,function(e,o){u.updateDropDownList(e.category,_.map(e.name,function(e){return _.pick(e,"name")}))}):u.updateDropDownList(e,[])})},u.updateDropDownList=function(e,o){o.length?u.categoryList[e]=_.unionBy(o,"name"):u.mapMasterCategoryList(u.formFieldProperties,e)},u.resetSelectedField=function(e){setTimeout(function(){$("#"+e).dropdown("restore defaults"),$("#"+e).dropdown("refresh")},0)},u.saveMetaData=function(e,o){if(u.isSubmit=!0,void 0!==e&&null!==e&&""!==e||(e={}),!n.metaForm.$valid&&u.updateErrorMessage(n.metaForm),n.metaForm.$valid)switch(r.current.name){case"CreateTextbook":t.$broadcast("CreateTextbook",{Data:e,framework:u.framework});break;case"CreateCourse":t.$broadcast("CreateCourse",{Data:e,framework:u.framework});break;case"CreateCollection":t.$broadcast("CreateCollection",{Data:e,framework:u.framework});break;case"CreateLesson":t.$broadcast("CreateLesson",{Data:e,framework:u.framework});break;case"CreateLessonPlan":t.$broadcast("CreateLessonPlan",{Data:e,framework:u.framework})}},u.updateErrorMessage=function(){n.metaForm.$valid||_.forEach(u.formFieldProperties,function(e,o){if(n.metaForm[e.code]&&n.metaForm[e.code].$invalid)switch(n.validation[e.code]={},_.keys(n.metaForm[e.code].$error)[0]){case"pattern":n.validation[e.code].errorMessage=e.validation.regex.message;break;case"required":n.validation[e.code].errorMessage="Plese Input a value";break;case"maxlength":n.validation[e.code].errorMessage=e.validation.max.message;break;default:n.validation[e.code].errorMessage="Invalid Input"}})},u.configureDropdowns=function(e,r){o(function(){$(".ui.dropdown").dropdown({useLabels:e,forceSelection:r,direction:"downward"}),u.loader.showLoader&&(u.loader.showLoader=!1)},1e3)},u.init=function(){u.loader=i.loader("",t.messages.stmsg.m0014),org.sunbird.portal.eventManager.addEventListener("editor:form:change",u.onConfigChange,u.formFieldProperties);var e={type:"content",action:"create"};switch(r.current.name){case"CreateTextbook":e.subType="textbook";break;case"CreateCourse":e.subType="course";break;case"CreateCollection":e.subType="collection";break;case"CreateLesson":e.subType="resource";break;case"CreateLessonPlan":e.subType="lessonplan"}s.getChannel().then(function(r){"OK"===r.responseCode&&(u.version=r.ver,u.framework=null,u.framework=r.result.channel.defaultFramework,s.getFramework(u.framework).then(function(r){if("OK"===r.responseCode){u.frameworkData=r.result.framework.categories;var a=_.cloneDeep(r.result.framework.categories);e.framework=u.framework,s.getDataDrivenFormsConfig(e).then(function(e){u.formFieldProperties=_.sortBy(e.result.form.data.fields,["index"]),_.forEach(a,function(e){_.forEach(u.formFieldProperties,function(o){return"year"===o.code&&(o.range=u.years),o.validation&&_.forEach(o.validation,function(e,r){"regex"===e.type&&(e.value=new RegExp(e.value)),o.validation[e.type]=e}),e.code===o.code&&e.terms&&(o.range=e.terms),o})});var r=["select","multiSelect"];o(function(){_.forEach(u.formFieldProperties,function(e){_.includes(r,e.inputType)&&($("#"+e.code).dropdown("set selected",u.frameworkData[e.code]),e.depends&&e.depends.length&&u.getAssociations(u.frameworkData[e.code],e.range,function(o){u.applyDependencyRules(e,o,!1)}))}),u.configureDropdowns(!1,!1)},0),u.mapMasterCategoryList(u.formFieldProperties)}).catch(function(e){console.log("error is ......",e)})}}).catch(function(e){console.log("error is ......",e)}))}).catch(function(e){console.log("error is ......",e)})}}]);