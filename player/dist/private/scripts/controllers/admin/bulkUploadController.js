"use strict";angular.module("playerApp").controller("bulkUploadController",["adminService","$timeout","$state","config","$rootScope","$scope","contentService","toasterService",function(e,s,o,r,a,l,t,d){var u=this;u.bulkUsers={},u.sampleOrgCSV=[{orgName:"orgName",isRootOrg:"isRootOrg",channel:"channel",externalId:"externalId",provider:"provider",description:"description",homeUrl:"homeUrl",orgCode:"orgCode",orgType:"orgType",preferredLanguage:"preferredLanguage",contactDetail:"contactDetail"}],u.sampleUserCSV=[{firstName:"firstName",lastName:"lastName",phone:"phone",email:"email",userName:"userName",password:"password",provider:"provider",phoneVerified:"phoneVerified",roles:"roles",position:"position",grade:"grade",location:"location",dob:"dob",gender:"gender",language:"language",profileSummary:"profileSummary",subject:"subject"}],u.orgBulkUpload=function(){u.showUploadOrgModal=!0,s(function(){$("#orgBulkUpload").modal({onShow:function(){u.fileName="",u.bulkOrgProcessId="",u.loader={}},onHide:function(){return u.loader={},u.fileName="",u.bulkOrgProcessId="",s(function(){u.showUploadOrgModal=!1},0),!0}}).modal("show")},0),$("#orgBulkUpload").modal("refresh")},u.userBulkUpload=function(){$("#userBulkUpload").modal("refresh"),u.showUploadUserModal=!0,s(function(){$("#userBulkUpload").modal({onShow:function(){u.bulkUsers={},u.fileName="",u.bulkUsersProcessId="",$("#bulkUsers").form("reset"),u.loader={},u.isUploadLoader=!1},onHide:function(){return s(function(){u.showUploadUserModal=!1},0),!0}}).modal("show")},0),$("#userBulkUpload").modal("refresh")},u.statusBulkUpload=function(){u.showStatusModal=!0,s(function(){$("#statusBulkUpload").modal({onShow:function(){$("#statusForm").form("reset"),u.uploadStatusKey="",u.bulkUploadStatus={},u.bulkUploadStatus.processId="",u.processID=""},onHide:function(){return u.bulkUploadStatus={},u.bulkUploadStatus.processId="",s(function(){u.showStatusModal=!1},0),!0}}).modal("show")},0),$("#statusBulkUpload").modal("refresh")},u.openImageBrowser=function(e){"users"===e?u.bulkUsers.provider&&u.bulkUsers.externalid||u.bulkUsers.OrgId?u.bulkUploadError||(u.isUploadLoader=!0,$("#uploadUsrsCSV").click()):(u.bulkUploadError=!0,u.bulkUploadErrorMessage=a.messages.emsg.m0003,u.bulkUploadError||s(function(){u.bulkUploadError=!1,u.bulkUploadErrorMessage="",u.bulkUsers={}},5e3)):"organizations"===e&&(u.isUploadLoader=!0,$("#orgUploadCSV").click())},l.validateFile=function(e,s){var o=new FormData,r=new FileReader;e[0]&&e[0].name.match(/.(csv)$/i)?(r.onload=function(){"users"===s?(o.append("user",e[0]),u.bulkUploadUsers(o)):"organizations"===s&&(o.append("org",e[0]),u.bulkUploadOrganizations(o))},u.fileName=e[0].name,r.readAsDataURL(e[0]),u.fileToUpload=o):d.error(a.messages.stmsg.m0080)},u.bulkUploadUsers=function(){$("#uploadUsrsCSV").val(""),u.loader=d.loader("",a.messages.stmsg.m0079),u.fileToUpload.append("organisationId",u.bulkUsers.OrgId||""),u.fileToUpload.append("externalId",u.bulkUsers.externalid),u.fileToUpload.append("provider",u.bulkUsers.provider),e.bulkUserUpload(u.fileToUpload).then(function(e){u.loader.showLoader=!1,"OK"===e.responseCode?(u.bulkUsersProcessId=e.result.processId,u.bulkUsersRes=e.result.response,d.success(a.messages.smsg.m0030)):"CLIENT_ERROR"===e.responseCode?d.error(e.params.errmsg):d.error(a.messages.fmsg.m0051)}).catch(function(e){u.loader.showLoader=!1,d.error(a.messages.fmsg.m0051)})},u.bulkUploadOrganizations=function(){$("#orgUploadCSV").val(""),u.loader=d.loader("",a.messages.stmsg.m0078),e.bulkOrgrUpload(u.fileToUpload).then(function(e){u.loader.showLoader=!1,"OK"===e.responseCode?(u.bulkOrgProcessId=e.result.processId,u.bulkOrgRes=e.result.response,d.success(a.messages.smsg.m0031)):"CLIENT_ERROR"===e.responseCode?d.error(e.params.errmsg):d.error(a.messages.fmsg.m0051)}).catch(function(e){u.loader.showLoader=!1,d.error(a.messages.fmsg.m0051)})},u.closeBulkUploadError=function(){u.bulkUploadError=!1,u.bulkUploadErrorMessage="",u.bulkUsers={}},u.getBulkUloadStatus=function(s,o){u.loader=d.loader("","Getting status "),e.bulkUploadStatus(s).then(function(e){if(u.loader.showLoader=!1,$("#statusBulkUpload").modal({observeChanges:!0}).modal("refresh"),"OK"===e.responseCode)u.uploadStatusKey=o,"string"==typeof e.result.response?d.success(e.result.response):(e.result.response[0].successResult.forEach(function(e){if(e.createdDate){var s=new Date(e.createdDate);e.createdDate=moment(s).format("DD/MM/YYYY")}}),u.bulkUploadStatus.success=e.result.response[0].successResult,u.bulkUploadStatus.failure=e.result.response[0].failureResult,u.bulkUploadStatus.processId=e.result.response[0].processId,u.bulkUploadStatus.objectType=e.result.response[0].objectType,d.success(a.messages.smsg.m0032));else{var s=e.params&&e.params.errmsg?e.params.errmsg:a.messages.fmsg.m0051;d.error(s)}}).catch(function(e){u.loader.showLoader=!1,d.error(a.messages.fmsg.m0051)})},u.downloadSample=function(e){"users"===e?alasql("SELECT * INTO CSV('Sample_Users.csv', {headers: false,separator:\",\"}) FROM ?",[u.sampleUserCSV]):"organizations"===e&&alasql(" SELECT *  INTO CSV('Sample_Organizations.csv', {headers: false,separator:\",\"}) FROM ?",[u.sampleOrgCSV])}}]);