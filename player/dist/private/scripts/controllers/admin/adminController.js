"use strict";angular.module("playerApp").controller("adminController",["adminService","$timeout","$state","config","$rootScope","$scope","contentService","toasterService","permissionsService","searchService",function(e,s,r,o,n,t,a,i,l,c){var u=this;u.searchResult=t.users,u.getOrgName=function(){var s=[];u.searchResult.forEach(function(e){if(e.organisations){var r=e.organisations.map(function(e){return e.organisationId});s=_.union(s,r)}});var r={request:{filters:{identifier:s}}};return e.orgSearch(r).then(function(e){return e.result.response.content.map(function(e){return{orgName:e.orgName,orgId:e.identifier}})})},u.addOrgNameToOrganizations=function(){u.currentUserRoles=l.getCurrentUserRoles(),u.currentUserRoleMap=l.getCurrentUserRoleMap(),"Users"===n.search.selectedSearchKey&&u.getOrgName().then(function(e){u.searchResult.forEach(function(s){if(s.roles){!0===s.roles.includes("SYSTEM_ADMINISTRATION")&&(s.isEditableProfile=u.currentUserRoles.includes("SYSTEM_ADMINISTRATION"))}s.badgeAssertions=s.badgeAssertions,s.organisations&&s.organisations.forEach(function(r){var o=u.currentUserRoleMap[r.organisationId];void 0===s.isEditableProfile&&(_.indexOf(o,"ORG_ADMIN")>-1||_.indexOf(o,"SYSTEM_ADMINISTRATION")>-1)&&(s.isEditableProfile=!0);var n=e.find(function(e){return e.orgId===r.organisationId});n&&(r.orgName=n.orgName)}),s.rootOrgId===n.rootOrgId&&!0===n.rootOrgAdmin&&(s.isEditableProfile=!0)})})},u.showModal=function(e,r){s(function(){$("#changeUserRoles_"+e).modal({onShow:function(){u.setDefaultSelected(r),u.identifier=e,u.userOrganisations=r,u.selectedOrgUserRoles=[],u.selectedOrgUserRolesNew=[],$(".roleChckbox").checkbox()},observeChanges:!0,closable:!1,onHide:function(){return u.userId="",u.userOrganisations=[],u.selectedOrgUserRoles=[],u.selectedOrgUserRolesNew=[],!0}}).modal("show")},100)},u.showdeleteModal=function(e,s,r){$("#deleteUserConfirmation").modal({onShow:function(){u.deletingIdentifier=e,u.deletingUserFullName=s+" "+r||""},onHide:function(){return u.deletingUserId="",u.deletingUserFullName="",!0}}).modal("show")},u.downloadUsers=function(e,s){if("Users"===e){s.forEach(function(e){e.organisationsName=[],e.organisations&&e.organisations.forEach(function(s){e.organisationsName.push(s.orgName)})});var r=JSON.stringify(s).replace(/null/g,'""'),o=JSON.parse(r);alasql("SELECT firstName AS [First Name],lastName AS [Last Name],  organisationsName AS Organizations ,location AS Location, grade AS Grades, language AS Language ,subject as Subjects  INTO CSV('Users.csv',{headers:true ,separator:\",\"}) FROM ?",[o])}else if("Organisations"===e){s.forEach(function(e){switch(e.status){case 0:e.status="INACTIVE";break;case 1:e.status="ACTIVE";break;case 2:e.status="BLOCKED";break;case 3:e.status="RETIRED"}});var n=JSON.stringify(s).replace(/null/g,'""'),t=JSON.parse(n);alasql("SELECT orgName AS orgName,orgType AS orgType,noOfMembers AS noOfMembers,channel AS channel, status AS Status INTO CSV('Organizations.csv',{headers:true,separator:\",\"}) FROM ?",[t])}},u.deleteUser=function(s){var r={params:{},request:{userId:s}};e.deleteUser(r).then(function(e){"SUCCESS"===e.result.response?(i.success(n.messages.smsg.m0029),u.searchResult=u.searchResult.filter(function(e){return e.identifier===s&&(e.status=0),e})):i.error(n.messages.fmsg.m0051)}).catch(function(e){i.error(n.messages.fmsg.m0051)})},u.isUserRole=function(e,s){return s.includes(e)},u.editRoles=function(e,s,r){!0===s.includes(e)?u.selectedOrgUserRoles=u.selectedOrgUserRoles.filter(function(s){return s!==e}):!0===r.target.checked?u.selectedOrgUserRolesNew.push(e):u.selectedOrgUserRolesNew.splice(u.selectedOrgUserRolesNew.indexOf(e))},u.updateRoles=function(s,r,o){u.selectedOrgUserRolesNew.forEach(function(e){o.push(e)});var t=[],a=_.clone(l.getMainRoles());_.forEach(a,function(e,s){t.push(e.role)});var c=_.clone(o),d=_.difference(c,t);_.remove(o,function(e){return-1!==_.indexOf(d,e)});var g={request:{userId:s,organisationId:r,roles:o}};e.updateRoles(g).then(function(e){"OK"===e.responseCode?(i.success(n.messages.smsg.m0028),$("#changeUserRoles_"+s).modal("hide",function(){$("#changeUserRoles_"+s).modal("hide")})):(u.selectedOrgUserRoles=_.difference(u.selectedOrgUserRoles,u.selectedOrgUserRolesNew),$("#changeUserRoles_"+s).modal("hide",function(){$("#changeUserRoles_"+s).modal("hide")}),i.error(n.messages.fmsg.m0051))}).catch(function(e){u.selectedOrgUserRoles=_.difference(u.selectedOrgUserRoles,u.selectedOrgUserRolesNew),i.error(n.messages.fmsg.m0051)})},u.getUserRoles=function(){u.userRolesList=[];var e=l.getMainRoles();u.userRoles=e.filter(function(e){return"ORG_ADMIN"!==e.role&&"SYSTEM_ADMINISTRATION"!==e.role&&"ADMIN"!==e.role})},u.openPublicProfile=function(e,s){c.setPublicUserProfile(s),r.go("PublicProfile",{userId:window.btoa(e),userName:s.firstName})},u.setDefaultSelected=function(e){e&&e.length>0&&s(function(){var s=$("#userOrgs_"+u.identifier);s.dropdown(),e[0].orgName?s.dropdown("set text",e[0].orgName):s.dropdown("set text",e[0].organisationId),s.dropdown({allowTab:!1}),u.selectedOrgUserRoles=e[0].roles,u.selectedOrgUserId=e[0].organisationId},1e3)},u.getUserRoles()}]);