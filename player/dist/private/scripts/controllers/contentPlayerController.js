"use strict";angular.module("playerApp").controller("contentPlayerCtrl",["$state","$scope","contentService","$timeout","$stateParams","config","$rootScope","$location","$anchorScroll","toasterService","$window","workSpaceUtilsService",function(e,t,n,o,a,r,i,s,c,d,l,u){function p(e){t.contentData=e,t.contentData.language=n.validateContent(t.contentData.language),t.contentData.gradeLevel=n.validateContent(t.contentData.gradeLevel),t.contentData.subject=n.validateContent(t.contentData.subject),t._instance={id:t.contentData.identifier,ver:t.contentData.pkgVersion},t.showMetaData=t.isshowmetaview,i.contentId=t.contentData.identifier,t.showIFrameContent=!0;var a=r.ekstep_CP_config.baseURL;o(function(){var n=$("#contentViewerIframe")[0];n.src=a,n.onload=function(){t.adjustPlayerHeight();var o=t.getContentEditorConfig(e);n.contentWindow.initializePreview(o),t.gotoBottom()}},0),document.getElementById("contentPlayer").addEventListener("renderer:telemetry:event",function(e,t){org.sunbird.portal.eventManager.dispatchEvent("sunbird:player:telemetry",e.detail.telemetryData)})}function g(e,n,o,a){var r={};r.showError=!0,r.showMetaLoader=e,r.messageClass="red",r.message=n,r.showCloseButton=o,r.showTryAgainButton=a,t.errorObject=r}function m(e){var o={contentId:e},a={fields:"body,editorState,templateId,languageCode,template,gradeLevel,status,concepts,versionKey,name,appIcon,contentType,owner,domain,code,visibility,createdBy,description,language,mediaType,osId,languageCode,createdOn,lastUpdatedOn,audience,ageGroup,attributions,artifactUrl,mimeType,medium,year,publisher,creator"};t.contenteditmode&&(a.mode="edit"),n.getById(o,a).then(function(e){if(e&&"OK"===e.responseCode)"Live"===e.result.content.status||"Unlisted"===e.result.content.status||t.isworkspace?(t.errorObject={},p(e.result.content)):f||(f+=1,d.warning(i.messages.imsg.m0027),l.history.back());else{g(!1,i.messages.stmsg.m0009,!0,!0)}}).catch(function(){g(!1,i.messages.stmsg.m0009,!0,!0)})}t.isClose=t.isclose,t.isHeader=t.isheader,t.showModalInLectureView=!0,t.contentProgress=0,t.telemetryEnv="Toc"===e.current.name?"course":"library";var f=0;t.getContentEditorConfig=function(e){var n={};if(n.context=r.ekstep_CP_config.context,n.context.contentId=t.contentData.identifier,n.context.sid=i.sessionId,n.context.uid=i.userId,n.context.channel=org.sunbird.portal.channel,_.isUndefined(a.courseId))n.context.dims=org.sunbird.portal.dims;else{var o=_.cloneDeep(org.sunbird.portal.dims)||[];o.push(a.courseId),i.batchHashTagId&&o.push(i.batchHashTagId),n.context.dims=o}return n.context.tags=_.concat([],org.sunbird.portal.channel),n.context.app=[org.sunbird.portal.appid],n.context.partner=[],i.isTocPage&&(n.context.cdata=[{id:a.courseId,type:"course"}]),n.context.pdata={id:org.sunbird.portal.appid,ver:"1.0",pid:"sunbird-portal"},n.config=r.ekstep_CP_config.config,n.config.plugins=r.ekstep_CP_config.config.plugins,n.config.repos=r.ekstep_CP_config.config.repos,n.metadata=t.contentData,n.data=t.contentData.mimeType!==r.MIME_TYPE.ecml?{}:e.body,n.config.overlay=r.ekstep_CP_config.config.overlay||{},n.config.overlay.showUser=!1,n},t.adjustPlayerHeight=function(){var e=$("#contentViewerIframe").width();if(e){var t=e*(9/16);$("#contentViewerIframe").css("height",t+"px")}},t.close=function(){if("Profile"===t.closeurl)return void e.go(t.closeurl);t.closeurl&&(""!==i.search.searchKeyword?o(function(){i.$emit("initSearch",{})},0):e.go(t.closeurl)),t.errorObject={},t.id&&(t.id=""),t.body&&(t.body={}),t.visibility=!1,document.getElementById("contentPlayer")&&document.getElementById("contentPlayer").removeEventListener("renderer:telemetry:event",function(){org.sunbird.portal.eventManager.dispatchEvent("sunbird:player:telemetry",event.detail.telemetryData)},!1)},t.updateContent=function(e){e.body?m(e.body.identifier):e.id&&m(e.id)},t.tryAgain=function(){t.errorObject={},m(t.id)},t.copyContent=function(){t.showCopyLoader=!0;var e=angular.copy(t.contentData);e.code=e.code+".copy",e.name="Copy of "+e.name;var o={content:{name:e.name,description:e.description,code:e.code,createdBy:i.userId}},a="";a="application/vnd.ekstep.ecml-archive"===t.contentData.mimeType?"WorkSpace.DraftContent":"WorkSpace.AllUploadedContent",n.copy(o,e.identifier).then(function(o){if(o&&"OK"===o.responseCode){_.forEach(o.result.node_id,function(t){e.identifier=t});var r={contentId:e.identifier},s={fields:"body,editorState,templateId,languageCode,template,gradeLevel,status,concepts,versionKey,name,appIcon,contentType,owner,domain,code,visibility,createdBy,description,language,mediaType,osId,languageCode,createdOn,lastUpdatedOn,audience,ageGroup,attributions,artifactUrl,mimeType,medium,year,publisher,creator,framework"};n.getById(r,s).then(function(e){e&&"OK"===e.responseCode?(d.success(i.messages.emsg.m0012),t.showCopyLoader=!1,u.openContentEditor(e.result.content,a)):(d.error(i.messages.emsg.m0013),t.showCopyLoader=!1)}).catch(function(){d.error(i.messages.emsg.m0013),t.showCopyLoader=!1})}else d.error(i.messages.emsg.m0013),t.showCopyLoader=!1}).catch(function(){d.error(i.messages.emsg.m0013),t.showCopyLoader=!1})},t.getConceptsNames=function(e){return n.getConceptsNames(e)},$("#courseDropdownValues").dropdown("restore defaults"),t.gotoBottom=function(){$("html, body").animate({scrollTop:$("#player-auto-scroll").offset().top},500)}}]);