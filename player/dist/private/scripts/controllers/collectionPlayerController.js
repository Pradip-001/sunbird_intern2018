"use strict";!function(){angular.module("playerApp").controller("CollectionPlayerCtrl",["$state","$timeout","courseService","$rootScope","$stateParams","toasterService","telemetryService","$window","contentService","workSpaceUtilsService",function(e,o,t,a,n,r,c,i,s,l){var d=this;d.treeKey=0,d.loader={showLoader:!1,loaderMessage:"",enrollLoader:!1},d.error={showError:!1,message:"",messageType:"error",isClose:!1,showEnrollError:!1},d.collectionMeta={creator:"-",language:"-",gradeLevel:"-",subject:"-",medium:"-",lastUpdatedOn:"-",createdOn:"-"},d.showPlayer=!1,d.name=e.params.name,d.closeUrl=n.backState||"Resources",d.loadData=function(){d.loader.showLoader=!0,d.loader.loaderMessage=a.messages.stmsg.m0076,t.courseHierarchy(e.params.Id).then(function(o){if(o&&"OK"===o.responseCode)if(d.loader.showLoader=!1,d.version=o.ver,"Live"===o.result.content.status||"Unlisted"===o.result.content.status)o.result.content.children=_.sortBy(o.result.content.children,["index"]),d.courseHierachy=o.result.content,d.name=d.courseHierachy.name,d.collectionMeta.creator=d.courseHierachy.creator,d.collectionMeta.language=d.courseHierachy.language,d.collectionMeta.gradeLevel=d.courseHierachy.gradeLevel,d.collectionMeta.subject=d.courseHierachy.subject,d.collectionMeta.medium=d.courseHierachy.medium,d.collectionMeta.lastUpdatedOn=d.courseHierachy.lastUpdatedOn,d.collectionMeta.createdOn=d.courseHierachy.createdOn,d.applyAccordion();else{r.warning(a.messages.imsg.m0018);var t=JSON.parse(i.localStorage.getItem("previousURl"));e.go(t.name,t.params)}else d.showError(a.messages.emsg.m0004)},function(){d.showError(a.messages.emsg.m0004)})},d.constructTree=function(e,o){d.fancyTree=[],angular.forEach(o,function(e,o){d.getTreeData(e,d.fancyTree)}),d.initializeFancyTree("#FT_"+e,d.fancyTree)},d.getTreeData=function(e,o){return"application/vnd.ekstep.content-collection"!==e.mimeType?(o.push({title:"<span id='node"+d.treeKey+"' class='padded'><i class='"+d.getContentIcon(e.mimeType)+"'></i>"+e.name+"</span>",key:d.treeKey,data:e,icon:!1}),d.treeKey+=1):(o.push({title:"<span class='courseAccordianDesc'><i class='"+d.getContentIcon(e.mimeType)+"'></i>"+e.name+"</span>",key:-1,children:[],icon:!1}),angular.forEach(e.children,function(t,a){d.getTreeData(e.children[a],o[o.length-1].children)})),d.fancyTree},d.initializeFancyTree=function(e,t){o(function(){$(e).fancytree({checkbox:!1,source:t,click:function(e,o){var t=o.node;-1!==t.key&&d.expandMe(t.key,t.data),"title"===o.targetType&&(o.targetType="expander",d.expandMe(t.key,t.data))}}),$(".fancytree-container").addClass("fancytree-connectors")},0)},d.expandMe=function(e,o){if(o&&o.mimeType&&"application/vnd.ekstep.content-collection"!==o.mimeType)d.playContent(o);else{var t=$(e.target).closest(".title").find("i");d.updateIcon(t,!$(t).hasClass("plus"))}},d.getContentIcon=function(e){return{"application/pdf":"large file pdf outline icon","image/jpeg":"large file image outline icon","image/jpg":"large file image outline icon","image/png":"large file image outline icon","video/mp4":"large file video outline icon","video/webm":"large file video outline icon","video/ogg":"large file video outline icon","video/youtube":"large youtube square icon","video/x-youtube":"large youtube square icon","application/vnd.ekstep.html-archive":"large html5 icon","application/vnd.ekstep.ecml-archive":"large file archive outline icon","application/vnd.ekstep.content-collection":"large folder open outline icon grey icon"}[e]},d.updateIcon=function(e,o){o?$(e).addClass("plus").removeClass("minus"):$(e).addClass("minus").removeClass("plus")},d.applyAccordion=function(){o(function(){$(".ui.accordion").accordion({exclusive:!1})},100)},d.playContent=function(e){d.contentId=e.identifier,d.showPlayer=!0},d.closePlayer=function(t){if("Profile"===n.backState)return void e.go(n.backState);""!==a.search.searchKeyword?o(function(){a.$emit("initSearch",{})},0):e.go("Resources")},d.copyContent=function(){d.showCopyLoader=!0;var e=angular.copy(d.courseHierachy);e.code=e.code+".copy",e.name="Copy of "+e.name;var o={content:{name:e.name,description:e.description,code:e.code,createdBy:a.userId}};s.copy(o,e.identifier).then(function(o){if(o&&"OK"===o.responseCode){_.forEach(o.result.node_id,function(o){e.identifier=o});var t={contentId:e.identifier},n={fields:"body,editorState,templateId,languageCode,template,gradeLevel,status,concepts,versionKey,name,appIcon,contentType,owner,domain,code,visibility,createdBy,description,language,mediaType,osId,languageCode,createdOn,lastUpdatedOn,audience,ageGroup,attributions,artifactUrl,mimeType,medium,year,publisher,creator,framework"};s.getById(t,n).then(function(e){e&&"OK"===e.responseCode?(r.success(a.messages.emsg.m0012),d.showCopyLoader=!1,l.openContentEditor(e.result.content,"WorkSpace.DraftContent")):(r.error(a.messages.emsg.m0013),d.showCopyLoader=!1)}).catch(function(){r.error(a.messages.emsg.m0013),d.showCopyLoader=!1})}else r.error(a.messages.emsg.m0013),d.showCopyLoader=!1}).catch(function(){r.error(a.messages.emsg.m0013),d.showCopyLoader=!1})},d.isShowBadgeAssign=function(e){switch(e.contentType){case"TextBook":return!0;default:return!1}},d.loadData()}])}();