"use strict";angular.module("playerApp").controller("NoteCardCtrl",["$rootScope","$scope","noteService","$timeout","$state","$stateParams","$q","toasterService",function(e,o,t,a,d,n,s,r){function i(o){var a="searchApi";l[a]={},l[a].loader=r.loader("",e.messages.stmsg.m0057),t.search(o).then(function(o){o&&"OK"===o.responseCode?(l[a].loader.showLoader=!1,l.notesList=o.result.response.note||[]):(l[a].loader.showLoader=!1,r.error(e.messages.fmsg.m0033))}).catch(function(){l[a].loader.showLoader=!1,r.error(e.messages.fmsg.m0033)})}var l=this;l.userId=e.userId,l.userName=e.firstName+" "+e.lastName,l.showNoteCard=o.shownotecard,l.showModalInLectureView=o.shownoteinlecture,l.showModalInCourseView=o.shownoteincourse,l.quantityOfNotes=2,l.courseId=n.courseId,l.contentId=n.contentId,l.contentName=n.contentName,l.add={},l.update={},l.showCreateNote=!1,l.showUpdateNote=!1,l.visibility=o.visibility,l.sortBy="desc",o.updateContentId=function(e){l.contentId=e},o.updateNoteMetaData=function(e){l.contentId=e,i({request:{filters:{userId:l.userId,courseId:l.courseId,contentId:l.contentId},sort_by:{updatedDate:l.sortBy}}})},l.hideAddNoteModal=function(){a(function(){$("#addNoteModal").modal("hide"),$("#addNoteModal").modal("hide dimmer"),$("#addNoteModal").modal("hide others")},0)},l.insertImage=function(){var e=s.defer();return l.openAddImageModal(function(o){o?e.resolve(o):e.reject()}),e.promise},l.openAddImageModal=function(e){l.showAddImageModal=!0,$(".wmd-prompt-background").css("z-index",0),$(".wmd-prompt-background").css("position","initial"),a(function(){$("#showAddImageModal").modal({allowMultiple:!0,onShow:function(){l.imageLink="http://"},onHide:function(){return l.showAddImageModal=!1,e(l.imageLink)}}).modal("show")},10)},l.closeAddImageModal=function(e){l.isCancel=!1,l.showUpdateModal=!1,e&&(l.imageLink="",l.isCancel=!0),l.showCreateNote?l.showAddNoteModal():l.showUpdateNote&&(l.showUpdateModal=!0,l.showUpdateNoteModal(l.update.metaData)),$("#showAddImageModal").modal("hide"),$("#showAddImageModal").modal("hide others"),$("#showAddImageModal").modal("hide all"),$("#showAddImageModal").modal("hide dimmer"),$(".ui.coupled.modal.transition.hidden").remove()},l.createNote=function(o){var a={request:{note:o.note,userId:l.userId,title:o.title,courseId:l.courseId,contentId:l.contentId,createdBy:l.userName,updatedBy:l.userId}},d="createApi";l[d]={},l[d].loader=r.loader("",e.messages.stmsg.m0054),t.create(a).then(function(o){if(o&&"OK"===o.responseCode){l[d].loader.showLoader=!1;var t=angular.copy(a.request);t.createdDate=(new Date).toISOString(),t.updatedDate=(new Date).toISOString(),t.id=o.result.id,l.hideAddNoteModal(),e.$emit("updateNotesListData",t)}else l[d].loader.showLoader=!1,r.error(e.messages.fmsg.m0030)}).catch(function(){l[d].loader.showLoader=!1,r.error(e.messages.fmsg.m0030)})},l.hideUpdateNoteModal=function(){$("#updateNoteModal").modal("hide"),$("#updateNoteModal").modal("hide others"),$("#updateNoteModal").modal("hide dimmer")},l.updateNote=function(o){var a={noteId:o.id,request:{note:o.note,title:o.title,tags:o.tags,updatedBy:l.userId}},d="updateApi";l[d]={},l[d].loader=r.loader("",e.messages.stmsg.m0059),t.update(a).then(function(t){if(t&&"OK"===t.responseCode){l[d].loader.showLoader=!1;var a=angular.copy(o);a.updatedDate=(new Date).toISOString(),l.hideUpdateNoteModal(),e.$emit("updateNotesListData",a,!0)}else l[d].loader.showLoader=!1,r.error(e.messages.fmsg.m0034)}).catch(function(){l[d].loader.showLoader=!1,r.error(e.messages.fmsg.m0034)})},l.clearUpdateNoteData=function(){l.update.metaData.title="",l.update.metaData.note=""},l.closeUpdateNoteModal=function(){a(function(){l.showUpdateNote=!1},0)},l.showUpdateNoteModal=function(e){l.showUpdateNote=!0,a(function(){$("#updateNoteModal").modal({allowMultiple:!0,onShow:function(){l.update.metaData=angular.copy(e),l.isCancel&&(l.imageLink="",l.isCancel=!1)},onHide:function(){return l.imageLink||l.isCancel||l.showUpdateModal||(l.clearUpdateNoteData(),l.closeUpdateNoteModal()),!0}}).modal("show")},10)},l.clearAddNoteData=function(){l.add.title="",l.add.note=""},l.closeAddNoteModal=function(){a(function(){l.showCreateNote=!1},0)},l.showAddNoteModal=function(){l.showCreateNote=!0,a(function(){$("#addNoteModal").modal({allowMultiple:!0,onShow:function(){l.imageLink||l.isCancel?(l.imageLink="",l.isCancel=!1):($(".ui.coupled.modal.transition.hidden").remove(),l.clearAddNoteData())},onHide:function(){return l.imageLink||l.isCancel||(l.clearAddNoteData(),l.closeAddNoteModal()),!0}}).modal("show")},10)},e.$on("updateNotesListData",function(e,o,t){t&&l.notesList?(l.notesList=l.notesList.filter(function(e){return e.id!==o.id}),l.notesList.push(o)):(l.notesList=l.notesList?l.notesList:[],l.notesList.push(o))}),l.viewAllNotes=function(){var e={};l.courseId&&l.contentId?(e={courseId:l.courseId,contentId:l.contentId},d.go("CourseContentNote",e)):l.courseId?(e={courseId:l.courseId},d.go("CourseNote",e)):l.contentId&&(e={contentId:l.contentId,contentName:l.contentName},d.go("ContentNote",e))}}]);