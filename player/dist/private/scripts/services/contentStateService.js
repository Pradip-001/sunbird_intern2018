"use strict";angular.module("playerApp").service("contentStateService",["$filter","$rootScope","restfulLearnerService","config","uuid4","dataService",function(t,e,s,n,r,o){var c=c||{},a=this;this.init=function(){org.sunbird.portal.eventManager.addEventListener("sunbird:telemetry:flush",a.updateContentState),org.sunbird.portal.eventManager.addEventListener("sunbird:player:telemetry",a.updateContentState)},this.getContentsStateFromAPI=function(t){return s.post(n.URL.COURSE.USER_CONTENT_STATE_READ,t)},this.updateContentStateInServer=function(t){return s.patch(n.URL.COURSE.USER_CONTENT_STATE_UPDATE,t)},this.prepareContentObject=function(s){var n={contentId:e.contentId,status:1,lastAccessTime:t("date")(new Date(s.ets),"yyyy-MM-dd HH:mm:ss:sssZ"),courseId:_.find(s.cdata,{type:"course"}).id,batchId:e.enrolledCourseIds[_.find(s.cdata,{type:"course"}).id].batchId},r=_.find(c[n.courseId].contents,{contentId:n.contentId});return r&&r.status>n.status&&(n.status=r.status),"OE_END"===s.eid&&s.edata&&s.edata.eks&&s.edata.eks.progress&&(n.progress=parseInt(s.edata.eks.progress),100===s.edata.eks.progress&&(n.status=2)),n},this.getContentsState=function(t,e){if(_.isEmpty(c)||!c[t.request.courseIds[0]]){var s=t.request.courseIds[0];c[s]={},c[s].contents=[],this.getContentsStateFromAPI(t).then(function(t){t&&"OK"===t.responseCode&&(c[s].contents=t.result.contentList),e(c[s].contents)},function(){e(c[s].contents)})}else e(c[t.request.courseIds[0]].contents)},a.updateContentState=function(s,n){if(n&&("OE_START"===n.eid||"OE_END"===n.eid)&&!0===o.getData("isTrackingEnabled")){var d=a.prepareContentObject(n),u=-1;if(c[d.courseId]&&c[d.courseId].contents){var i=_.find(c[d.courseId].contents,{contentId:d.contentId,courseId:d.courseId}),I=_.findIndex(c[d.courseId].contents,{contentId:d.contentId,courseId:d.courseId});i?(c[d.courseId].contents[I].progress=d.progress&&i.progress&&parseInt(i.progress)<d.progress?d.progress:c[d.courseId].contents[I].progress,c[d.courseId].contents[I].lastAccessTime=d.lastAccessTime,u=c[d.courseId].contents[I].status,c[d.courseId].contents[I].status=d.status):-1===I&&c[d.courseId].contents.push(d)}c[d.courseId].currentContent=d.contentId;var p={id:r.generate(),ts:t("date")(new Date,"yyyy-MM-dd HH:mm:ss:sssZ"),params:{},request:{userId:e.userId,contents:[d]}};console.log("called flush"),u<d.status&&a.updateContentStateInServer(p).then(function(t){})}}}]);