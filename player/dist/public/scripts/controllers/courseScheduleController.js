"use strict";angular.module("loginApp").controller("courseScheduleCtrl",["contentService","$stateParams","$state","$timeout","$scope","$rootScope","toasterService","$location","$window","config",function(e,t,n,o,r,s,a,i,c,l){var u=this;u.playList=[],u.playListContent=[],u.loading=!1,u.courseParams=t,r.contentList=[],u.contentList=[],u.showNoteInLecture=!0,u.enrollErrorMessage="",u.fancyTree=[],u.treeKey=0,u.uid=s.userId,u.statusClass={0:"grey",1:"blue",2:"green"},u.showError=function(e){u.loader.showLoader=!1,u.error.showError=!0,u.error.message=e},u.storeCourseDetail=function(e,t){var n={COURSE_PARAMS:{courseType:"OTHER_COURSE",courseId:t,lectureView:"yes",progress:0,total:u.courseTotal,courseName:e,lastReadContentId:null}};c.sessionStorage.setItem("sbConfig",JSON.stringify(n))},u.getCourseToc=function(){u.loader=a.loader("",s.messages.stmsg.m0003),e.courseHierarchy(u.courseId).then(function(e){if(e&&"OK"===e.responseCode){if(l.CONTENT_TYPE.course!==e.result.content.contentType)return a.warning("Invalid course access"),void n.go("Landing");s.titleName=e.result.content.name,window.localStorage.setItem("redirectUrl","/course/"+u.courseId+"/yes"),u.loader.showLoader=!1,e.result.content.children=_.sortBy(e.result.content.children,["index"]),u.getAllContentsFromCourse(e.result.content),u.contentCountByType=_.countBy(u.playListContent,"mimeType"),u.courseTotal=u.courseTotal||u.playList.length,u.courseParams.lastReadContentId&&(u.itemIndex=u.playList.indexOf(u.courseParams.lastReadContentId)),u.courseHierachy=e.result.content,s.courseName=u.courseHierachy.name,u.applyAccordion(),u.storeCourseDetail(s.courseName,u.courseId)}else u.loader.showLoader=!1,a.error(s.messages.fmsg.m0003),n.go("Landing")},function(){u.loader.showLoader=!1,a.error(s.messages.fmsg.m0003),n.go("Landing")})},u.expandMe=function(e,t){if(t&&t.mimeType&&"application/vnd.ekstep.content-collection"!==t.mimeType)u.itemIndex=u.playList.indexOf(t.identifier),u.playPlaylistContent(t.identifier,"");else{var n=$(e.target).closest(".title").find("i");u.updateIcon(n,!$(n).hasClass("plus"))}},u.updateIcon=function(e,t){t?$(e).addClass("plus").removeClass("minus"):$(e).addClass("minus").removeClass("plus")},u.checkAndAddToPlaylist=function(e){"application/vnd.ekstep.content-collection"!==e.mimeType&&-1===u.playList.indexOf(e.identifier)&&(u.playList.push(e.identifier),u.playListContent.push(e))},u.getAllChildrenCount=function(e){return u.getChildNodeCount(u.courseHierachy.children[e],0)},u.getChildNodeCount=function(e,t){return void 0===e.children||0===e.children.length?t:(t+=e.children.length,e.children.forEach(function(e){var n=u.getChildNodeCount(e,t);t=parseInt(n,10)}),t)},u.getAllContentsFromCourse=function(e){return"application/vnd.ekstep.content-collection"!==e.mimeType?(u.playList.push(e.identifier),u.playListContent.push(e)):angular.forEach(e.children,function(t,n){u.getAllContentsFromCourse(e.children[n])}),u.playList},u.getTreeData=function(e,t){return"application/vnd.ekstep.content-collection"!==e.mimeType?(t.push({title:'<span id="node'+u.treeKey+'" class="padded"><img src="'+u.getContentIcon(e.mimeType)+'" class="tocCourseStructureImg">'+e.name+'</span><button id="resume-button-'+u.treeKey+'" class="toc-resume-button contentVisibility-hidden blue right floated ui small button">RESUME</button',key:u.treeKey,data:e,icon:!1}),u.treeKey+=1):(t.push({title:'<span class="courseAccordianDesc"><i class="'+u.getContentIcon(e.mimeType)+'"></i>'+e.name+"</span>",key:-1,children:[],icon:!1}),angular.forEach(e.children,function(n,o){u.getTreeData(e.children[o],t[t.length-1].children)})),u.fancyTree},u.getContentClass=function(e){var t={0:"grey",1:"blue",2:"green"};return"ENROLLED_COURSE"===u.courseType?t[u.contentStatusList[e]||0]:0},u.getContentIcon=function(e,t){return t=t||"",{"application/pdf":"/common/images/pdf"+t+".png","video/mp4":"/common/images/video"+t+".png","video/x-youtube":"/common/images/video"+t+".png","video/youtube":"/common/images/video"+t+".png","application/vnd.ekstep.html-archive":"/common/images/app"+t+".png","application/vnd.ekstep.ecml-archive":"/common/images/app"+t+".png","application/epub":"/common/images/app"+t+".png","application/vnd.ekstep.h5p-archive":"/common/images/video"+t+".png","application/vnd.ekstep.content-collection":"/common/images/folder.png"}[e]},u.applyAccordion=function(){o(function(){$(".ui.accordion").accordion({exclusive:!1}),"ENROLLED_COURSE"===u.courseType&&u.playList.length>0&&"no"===u.lectureView&&"Flagged"!==u.courseHierachy.status&&u.resumeCourse();var e=parseInt(100*u.courseProgress/u.courseTotal,0);$(".toc-resume-button").addClass("contentVisibility-hidden"),$("#tocProgress").progress({percent:e})},100)},u.constructTree=function(e,t){u.fancyTree=[],angular.forEach(t,function(e,t){u.getTreeData(e,u.fancyTree)}),u.initializeFancyTree("#FT_"+e,u.fancyTree)},u.initializeFancyTree=function(e,t){o(function(){$(e).fancytree({checkbox:!1,source:t,click:function(e,t){var n=t.node;-1!==n.key&&u.expandMe(n.key,n.data)},create:function(e,t){"OTHER_COURSE"===u.courseType&&$(".fancytree-title").addClass("noselect")}}),$(".fancytree-container").addClass("fancytree-connectors")},0)},u.fetchObjectAttributeAsArrayOrObject=function(e,t,n,o){var r=!0===o?{}:[];for(var s in e)void 0!==e[s]&&(o?r[e[s][t]]=n?e[s][n]:e[s]:r.push(e[s][t]));return r},r.$watch("contentPlayer.isContentPlayerEnabled",function(e,t){$(".toc-resume-button").addClass("contentVisibility-hidden"),!0===t&&!1===e&&(u.hashId="",i.hash(u.hashId),u.getContentState(),$(".fancy-tree-container").each(function(){var e=this.id;$(this).fancytree("getTree").visit(function(t){t.key===u.itemIndex.toString()?(o(function(){$("#"+e).closest(".accordion").find(".title").hasClass("active")||$("#"+e).closest(".accordion").find(".title").trigger("click"),t.setActive(!1)},10),t.setExpanded(!0),t.setActive(!0),t.setFocus(!1),$("#resume-button-"+u.itemIndex).removeClass("contentVisibility-hidden")):(t.setActive(!1),t.setFocus(!1))})}),u.updateBreadCrumbs())}),u.updateBreadCrumbs=function(){if(s.breadCrumbsData=[{name:"Home",link:"home"},{name:"Courses",link:"learn"},{name:u.courseName,link:"/toc//"+u.courseId+"/"+u.lectureView}],r.contentPlayer.isContentPlayerEnabled){var e=u.playListContent[u.itemIndex].name;u.courseParams.contentName=e,u.courseParams.contentId=u.playList[u.itemIndex],u.courseParams.contentIndex=u.itemIndex;var t={name:e,link:""};sessionService.setSessionData("COURSE_PARAMS",u.courseParams),s.breadCrumbsData[3]?s.breadCrumbsData[3]=t:s.breadCrumbsData.push(t)}},u.init=function(){u.lectureView=u.courseParams.lectureView,u.courseId=u.courseParams.courseId,u.courseTotal=u.courseParams.total,u.courseName=u.courseParams.courseName,u.contentStatusList={},r.enableCloseButton="yes"===u.lectureView?"false":"true",u.nightMode=!0,u.itemIndex=parseInt(t.contentIndex,0)||0,r.contentPlayer={isContentPlayerEnabled:!1},u.loader={showLoader:!1,loaderMessage:"",enrollLoader:!1},u.error={showError:!1,message:"",messageType:"error",isClose:!1,showEnrollError:!1},u.playItemIndex=void 0,u.getCourseToc()},u.loadData=function(){u.courseParams.courseId!==t.courseId||u.init()}}]);