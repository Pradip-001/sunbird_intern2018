"use strict";angular.module("loginApp").controller("contentPlayerCtrl",["$state","$scope","$timeout","$stateParams","$rootScope","config","contentService","toasterService","$location","$anchorScroll",function(e,t,n,o,a,i,c,r,s,l){function d(e){return _.isArray(e)?_.compact(e).join(", "):""}function g(e){t.contentData=e,t.contentData.language=d(t.contentData.language),t.contentData.gradeLevel=d(t.contentData.gradeLevel),t.contentData.subject=d(t.contentData.subject),t._instance={id:t.contentData.identifier,ver:t.contentData.pkgVersion},t.showMetaData=t.isshowmetaview,a.contentId=t.contentData.identifier,t.showIFrameContent=!0;var o=i.ekstep_CP_config.baseURL;n(function(){var n=$("#contentViewerIframe")[0];n.src=o,n.onload=function(){t.adjustPlayerHeight();var o=t.getContentEditorConfig(e);n.contentWindow.initializePreview(o),t.gotoBottom()}},0)}function u(n){var o={contentId:n},s={fields:"body,editorState,stageIcons,templateId,languageCode,template,gradeLevel,status,concepts,versionKey,name,appIcon,contentType,owner,domain,code,visibility,createdBy,description,language,mediaType,osId,languageCode,createdOn,lastUpdatedOn,audience,ageGroup,attributions,artifactUrl,mimeType,medium,year,publisher,creator"};c.getById(o,s).then(function(o){if(o&&"OK"===o.responseCode)if(-1===i.CONTENT_TYPE.resource.indexOf(o.result.content.contentType)&&(r.warning(a.messages.fmsg.m0065),e.go("Landing")),t.errorObject={},o.result.content.mimeType===i.MIME_TYPE.collection){var c=o.result.content;window.localStorage.setItem("redirectUrl","/preview/collection/"+n+"/"+c.name+"/"),e.go("PublicCollection",{contentId:c.identifier,name:c.name})}else g(o.result.content),t.isClose||(a.titleName=o.result.content.name,window.localStorage.setItem("redirectUrl","/content/"+n+"/"+o.result.content.name));else r.error(a.messages.fmsg.m0049),e.go("Landing")}).catch(function(){r.error(a.messages.fmsg.m0049),e.go("Landing")})}t.isHeader=t.isheader,t.isClose=t.isclose,t.showModalInLectureView=!0,t.contentProgress=0,t.getContentEditorConfig=function(e){var n={};return n.context=i.ekstep_CP_config.context,n.context.contentId=t.contentData.identifier,n.context.sid=a.sessionId,n.context.uid=a.userId,n.context.partner=[],n.context.cdata=[{id:o.courseId,type:"course"}],n.context.pdata={id:$("#producerId").attr("value"),ver:"1.0",pid:"sunbird-portal"},n.config=i.ekstep_CP_config.config,n.config.plugins=i.ekstep_CP_config.config.plugins,n.config.repos=i.ekstep_CP_config.config.repos,n.metadata=t.contentData,n.data=t.contentData.mimeType!==i.MIME_TYPE.ecml?{}:e.body,n.config.overlay=i.ekstep_CP_config.config.overlay||{},n.config.overlay.showUser=!1,n},t.adjustPlayerHeight=function(){var e=$("#contentViewerIframe").width();if(e){var t=e*(9/16);$("#contentViewerIframe").css("height",t+"px")}},t.close=function(){t.visibility=!1},t.init=function(){t.errorObject={},u(t.id)},t.$watch("id",function(e,t){u(e)}),t.getConceptsNames=function(e){if(_.isArray(e)){return _.map(e,"name").join(", ")}},t.gotoBottom=function(){$("html, body").animate({scrollTop:$("#player-auto-scroll").offset().top},500)}}]);